<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Insurance Referral Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --secondary-accent: #ae8625; 
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        h1, h2, h3, h4 { font-family: 'Source Serif Pro', serif; color: var(--primary-accent); }
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            border: 1px solid var(--border-color);
        }
        .button-base { 
            font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease;
            text-transform: uppercase; letter-spacing: 0.025em; cursor: pointer; 
        }
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .primary-btn:hover { background-color: #003d4d; }
        
        .status-select, .approved-premium-input {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-bento-box);
        }
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--primary-accent);
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen">
    <div id="admin-app" class="w-full max-w-7xl mx-auto my-8 p-4 md:p-6 lg:p-8 hidden">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold">Admin Dashboard</h1>
                <p id="admin-greeting" class="text-lg text-[var(--text-secondary)]"></p>
            </div>
            <button id="logout-btn" class="button-base bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-4">Logout</button>
        </header>

        <main class="space-y-12">
            <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bento-box">
                    <h2 class="text-lg font-semibold text-[var(--text-secondary)]">Pending Referrals</h2>
                    <p id="pending-referrals-count" class="text-4xl font-bold text-[var(--primary-accent)]">0</p>
                </div>
                <div class="bento-box">
                    <h2 class="text-lg font-semibold text-[var(--text-secondary)]">Total Finder's Fees Owed (This Month)</h2>
                    <p id="finders-fee-owed-total" class="text-4xl font-bold text-[var(--primary-accent)]">$0.00</p>
                </div>
                <div class="bento-box">
                    <h2 class="text-lg font-semibold text-[var(--text-secondary)]">Total Referrers</h2>
                    <p id="total-referrers-count" class="text-4xl font-bold text-[var(--primary-accent)]">0</p>
                </div>
            </section>
            
            <section>
                <h2 class="text-2xl font-bold mb-6">All Referrals</h2>
                <div class="bento-box overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="whitespace-nowrap">
                            <tr class="border-b border-[var(--border-color)]">
                                <th class="p-4 text-sm font-semibold">Date</th>
                                <th class="p-4 text-sm font-semibold">Referrer</th>
                                <th class="p-4 text-sm font-semibold">Client</th>
                                <th class="p-4 text-sm font-semibold">Type</th>
                                <th class="p-4 text-sm font-semibold text-right">Original Fee</th>
                                <th class="p-4 text-sm font-semibold text-right">Approved Premium</th>
                                <th class="p-4 text-sm font-semibold text-right">Final Fee</th>
                                <th class="p-4 text-sm font-semibold text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="admin-referrals-table-body">
                            </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Verifying Admin Access...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTHENTICATION & AUTHORIZATION ---
        onAuthStateChanged(auth, async (user) => {
            const adminApp = document.getElementById('admin-app');
            const loaderEl = document.getElementById('auth-loader');

            if (user) {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    document.getElementById('admin-greeting').textContent = `Welcome, ${user.displayName || user.email}!`;
                    adminApp.classList.remove('hidden');
                    loaderEl.classList.add('hidden');
                    loadAdminData();
                } else {
                    showAccessDenied(loaderEl);
                }
            } else {
                showAccessDenied(loaderEl);
            }
        });
        
        function showAccessDenied(loaderEl) {
            loaderEl.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-gavel text-5xl text-red-500 mx-auto mb-4"></i>
                    <h3 class="text-xl font-bold leading-6 mb-2">Access Denied</h3>
                    <p class="text-[var(--text-secondary)]">You do not have permission to view this page.</p>
                    <div class="mt-6">
                        <a href="./index.html" class="button-base primary-btn py-2 px-4">Go to Login</a>
                    </div>
                </div>
            `;
        }

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));


        // --- DASHBOARD DATA LOADING & DISPLAY ---
        function loadAdminData() {
            const referralsRef = collection(db, "referrals");
            const usersRef = collection(db, "users");

            onSnapshot(referralsRef, (snapshot) => {
                const referrals = [];
                snapshot.forEach(doc => referrals.push({ id: doc.id, ...doc.data() }));
                displayReferrals(referrals);
                updateSummaryCards(referrals);
            });
            
             onSnapshot(usersRef, (snapshot) => {
                let referrerCount = 0;
                snapshot.forEach(doc => {
                    if(doc.data().role === 'referrer') referrerCount++;
                });
                document.getElementById('total-referrers-count').textContent = referrerCount;
             });
        }

        function updateSummaryCards(referrals) {
            const pendingCount = referrals.filter(r => r.status === 'Pending').length;
            document.getElementById('pending-referrals-count').textContent = pendingCount;
            
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const feeOwed = referrals
                .filter(r => r.status === 'Won' && r.createdAt.toDate() >= startOfMonth)
                .reduce((total, r) => total + (r.finalFindersFee || r.findersFee), 0);
            
            document.getElementById('finders-fee-owed-total').textContent = formatCurrency(feeOwed);
        }

        function displayReferrals(referrals) {
            const tableBody = document.getElementById('admin-referrals-table-body');
            if (referrals.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center p-8 text-[var(--text-muted)]">No referrals have been made yet.</td></tr>';
                return;
            }

            referrals.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());

            tableBody.innerHTML = referrals.map(ref => {
                const isApprovedOrWon = ref.status === 'Approved' || ref.status === 'Won';
                const finalFee = ref.finalFindersFee || ref.findersFee;
                return `
                    <tr class="border-b border-[var(--border-color)]">
                        <td class="p-4">${ref.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="p-4">${ref.referrerName}</td>
                        <td class="p-4">${ref.clientName}</td>
                        <td class="p-4">${ref.insuranceType}</td>
                        <td class="p-4 text-right">${formatCurrency(ref.findersFee)}</td>
                        <td class="p-2 text-right">
                            <input type="number" 
                                class="approved-premium-input w-28 text-right" 
                                data-id="${ref.id}" 
                                value="${ref.approvedPremium || ''}"
                                placeholder="0.00"
                                ${!isApprovedOrWon ? 'disabled' : ''}>
                        </td>
                         <td class="p-4 text-right font-semibold text-green-600">${formatCurrency(finalFee)}</td>
                        <td class="p-4 text-center">
                            <select class="status-select" data-id="${ref.id}">
                                <option value="Pending" ${ref.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Approved" ${ref.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                <option value="Won" ${ref.status === 'Won' ? 'selected' : ''}>Won</option>
                                <option value="Lost" ${ref.status === 'Lost' ? 'selected' : ''}>Lost</option>
                                <option value="Rejected" ${ref.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                            </select>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add event listeners
            tableBody.querySelectorAll('.status-select').forEach(el => el.addEventListener('change', handleStatusChange));
            tableBody.querySelectorAll('.approved-premium-input').forEach(el => el.addEventListener('change', handlePremiumChange));
        }
        
        function calculateNewFindersFee(approvedPremium, insuranceType) {
            const commissionRate = insuranceType === 'Motor' ? 0.10 : 0.25;
            const totalCommission = approvedPremium * commissionRate;
            const incomeTax = totalCommission * 0.25;
            const netCommission = totalCommission - incomeTax;
            return netCommission * 0.50;
        }

        async function handlePremiumChange(event) {
            const input = event.target;
            const referralId = input.dataset.id;
            const approvedPremium = parseFloat(input.value);

            if (isNaN(approvedPremium) || approvedPremium < 0) return;
            
            const referralRef = doc(db, "referrals", referralId);
            
            try {
                const referralDoc = await getDoc(referralRef);
                if (!referralDoc.exists()) return;

                const newFee = calculateNewFindersFee(approvedPremium, referralDoc.data().insuranceType);
                
                await updateDoc(referralRef, {
                    approvedPremium: approvedPremium,
                    finalFindersFee: newFee
                });

            } catch (error) {
                console.error("Error updating premium: ", error);
                alert("Could not update premium.");
            }
        }
        
        async function handleStatusChange(event) {
            const selectElement = event.target;
            const referralId = selectElement.dataset.id;
            const newStatus = selectElement.value;
            
            selectElement.disabled = true;
            const referralRef = doc(db, "referrals", referralId);
            
            try {
                await updateDoc(referralRef, { status: newStatus });
            } catch (error) {
                console.error("Error updating status: ", error);
                alert("Could not update status. Please try again.");
            } finally {
                 selectElement.disabled = false;
            }
        }
        
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '$0.00';
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
    </script>
</body>
</html>
