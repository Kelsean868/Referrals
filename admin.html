<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Insurance Referral Hub</title>
    
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005f73">
    <meta name="mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Referral Hub Admin">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/005f73/FFFFFF?text=Hub">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --secondary-accent: #ae8625; 
            --gold-accent: #FFD700;
            --silver-accent: #C0C0C0;
            --bronze-accent: #CD7F32;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
        }
        h1, h2, h3, h4 { font-family: 'Source Serif Pro', serif; color: var(--primary-accent); }
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            border: 1px solid var(--border-color);
        }
        .button-base { 
            font-weight: 600; padding: 0.5rem 1rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease, opacity 0.2s ease;
            text-transform: uppercase; letter-spacing: 0.025em; cursor: pointer; 
            text-decoration: none;
            display: inline-block;
        }
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .primary-btn:hover:not(:disabled) { background-color: #003d4d; }
        .secondary-btn { background-color: var(--secondary-accent); color: white; }
        .secondary-btn:hover:not(:disabled) { background-color: #8c6c1d; }
        .button-base:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .form-input, .status-select, .approved-premium-input, .modal-input, .modal-select, .commission-split-input {
            padding: 0.5rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-main);
            width: 100%;
        }
        .form-input:disabled, .status-select:disabled, .approved-premium-input:disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            color: var(--text-muted);
            border-color: #e9ecef;
        }

        /* Style for rows with pending changes */
        .pending-changes {
            background-color: #fffbeb; /* Light yellow */
            outline: 2px solid #fBBF24; /* Amber */
        }
        
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--primary-accent);
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(29, 45, 53, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); overflow-y: auto; }
        .modal-content { background-color: var(--bg-bento-box); margin: auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 720px; border-radius: 0.75rem; position: relative; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .tier-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .tier-Bronze { background-color: var(--bronze-accent); color: white; }
        .tier-Silver { background-color: var(--silver-accent); color: var(--text-primary); }
        .tier-Gold { background-color: var(--gold-accent); color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen">
    <div id="admin-app" class="w-full max-w-7xl mx-auto my-8 p-4 md:p-6 lg:p-8 hidden">
        <header class="flex flex-wrap justify-between items-center mb-10 gap-4">
            <div>
                <h1 class="text-3xl sm:text-4xl font-bold">Admin Dashboard</h1>
                <p id="admin-greeting" class="text-lg text-[var(--text-secondary)]"></p>
            </div>
            <div class="flex items-center space-x-4">
                <a href="./index.html" class="button-base bg-[var(--secondary-accent)] text-white text-sm py-2 px-4 hover:bg-[#8c6c1d]">Referrer Hub</a>
                <button id="logout-btn" class="button-base bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-4">Logout</button>
            </div>
        </header>

        <main class="space-y-12">
             <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="bento-box">
                    <h2 class="text-lg font-semibold text-[var(--text-secondary)]">Pending Referrals</h2>
                    <p id="pending-referrals-count" class="text-4xl font-bold text-[var(--primary-accent)]">0</p>
                </div>
                <div class="bento-box">
                    <h2 class="text-lg font-semibold text-[var(--text-secondary)]">Unpaid Fees (All Time)</h2>
                    <p id="finders-fee-owed-total" class="text-4xl font-bold text-[var(--primary-accent)]">$0.00</p>
                </div>
                <div class="bento-box">
                    <h2 class="text-lg font-semibold text-[var(--text-secondary)]">Total Referrers</h2>
                    <p id="total-referrers-count" class="text-4xl font-bold text-[var(--primary-accent)]">0</p>
                </div>
                <div class="bento-box md:col-span-2 lg:col-span-1">
                     <h2 class="text-lg font-semibold text-center text-[var(--text-secondary)]">This Month's Performance</h2>
                     <div class="relative h-48 w-48 mx-auto mt-4">
                        <canvas id="performanceChart"></canvas>
                     </div>
                </div>
            </section>
            
            <section id="payout-section" class="bento-box">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div>
                        <h2 class="text-xl font-bold">Process Payouts</h2>
                        <p id="payout-period-label" class="text-[var(--text-secondary)]">For business won in the previous month.</p>
                    </div>
                    <div class="text-right">
                         <p id="payout-total" class="text-2xl font-bold text-green-600">$0.00</p>
                         <button id="process-payout-btn" class="button-base primary-btn mt-2" disabled>Finalize & Pay</button>
                    </div>
                </div>
            </section>
            
            <section>
                 <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">Commission Tier Management</h2>
                    <div class="flex gap-4">
                        <button id="recalculate-counts-btn" class="button-base secondary-btn">Recalculate All Counts</button>
                        <button id="save-tiers-btn" class="button-base primary-btn">Save Tier Settings</button>
                    </div>
                </div>
                <div id="tier-settings-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                </div>
            </section>

            <section>
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold">All Referrals</h2>
                    <div id="referral-actions" class="flex items-center gap-4">
                         <button id="manual-entry-btn" class="button-base secondary-btn">Add Referral</button>
                         <button id="edit-referrals-btn" class="button-base primary-btn">Edit Referrals</button>
                         <button id="save-referrals-btn" class="button-base bg-green-600 text-white hidden">Save Changes</button>
                         <button id="cancel-referrals-btn" class="button-base bg-gray-500 text-white hidden">Cancel</button>
                    </div>
                </div>
                <div class="bento-box overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="whitespace-nowrap">
                            <tr class="border-b border-[var(--border-color)]">
                                <th class="p-4 text-sm font-semibold">Referrer</th>
                                <th class="p-4 text-sm font-semibold">Client</th>
                                <th class="p-4 text-sm font-semibold text-right">Approved Premium</th>
                                <th class="p-4 text-sm font-semibold text-right">Final Fee</th>
                                <th class="p-4 text-sm font-semibold text-center">Status</th>
                                <th class="p-4 text-sm font-semibold text-center">Fee Waived</th>
                            </tr>
                        </thead>
                        <tbody id="admin-referrals-table-body"></tbody>
                    </table>
                </div>
            </section>

            <section>
                <h2 class="text-2xl font-bold mb-6">Manage Referrers</h2>
                <div class="bento-box overflow-x-auto">
                    <table class="w-full text-left">
                        <thead class="whitespace-nowrap">
                            <tr class="border-b border-[var(--border-color)]">
                                <th class="p-4 text-sm font-semibold">Referrer Name</th>
                                <th class="p-4 text-sm font-semibold">Email</th>
                                <th class="p-4 text-sm font-semibold">Current Tier</th>
                                <th class="p-4 text-sm font-semibold text-right">Won Referrals</th>
                                <th class="p-4 text-sm font-semibold text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="referrers-management-table-body"></tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Verifying Admin Access...</p>
    </div>
    
    <!-- Modals -->
    <div id="manual-entry-modal" class="modal-overlay hidden">
        <!-- ... (modal content is unchanged) ... -->
    </div>
    
    <div id="admin-edit-profile-modal" class="modal-overlay hidden">
        <!-- ... (modal content is unchanged) ... -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-functions.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const functions = getFunctions(app);

        let allReferralsData = [];
        let allReferrers = [];
        let commissionTiers = [];
        let pendingReferralChanges = {};
        let isEditMode = false;
        let performanceChart = null;
        
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '$0.00';
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }

        function displayReferrals(referrals) {
            const tableBody = document.getElementById('admin-referrals-table-body');
            tableBody.innerHTML = referrals.map(ref => {
                const finalFee = ref.feeWaived ? 0 : (ref.finalFindersFee || ref.findersFee || 0);
                const isPaid = ref.status === 'Paid';
                const rowClass = isPaid ? 'opacity-50' : (pendingReferralChanges[ref.id] ? 'pending-changes' : '');

                return `
                    <tr id="ref-row-${ref.id}" class="border-b border-[var(--border-color)] ${rowClass}">
                        <td class="p-4">${ref.referrerName}</td>
                        <td class="p-4">${ref.clientName}</td>
                        <td class="p-2 text-right">
                            <input type="number" class="approved-premium-input w-28 text-right" data-id="${ref.id}" value="${ref.approvedPremium || ''}" ${!isEditMode || isPaid ? 'disabled' : ''}>
                        </td>
                         <td class="p-4 text-right font-semibold text-green-600">${formatCurrency(finalFee)}</td>
                        <td class="p-4 text-center">
                            <select class="status-select" data-id="${ref.id}" ${!isEditMode || isPaid ? 'disabled' : ''}>
                                ${['Pending', 'Approved', 'Won', 'Lost', 'Rejected', 'Cancelled', 'Resubmitted', 'Paid'].map(s => `<option value="${s}" ${ref.status === s ? 'selected' : ''} ${isPaid && s !== 'Paid' ? 'disabled' : ''}>${s}</option>`).join('')}
                            </select>
                        </td>
                        <td class="p-4 text-center">
                            <input type="checkbox" class="h-5 w-5 fee-waiver-checkbox" data-id="${ref.id}" ${ref.feeWaived ? 'checked' : ''} ${!isEditMode || isPaid ? 'disabled' : ''}>
                        </td>
                    </tr>
                `;
            }).join('');
            
            attachReferralTableListeners();
        }
        
        function attachReferralTableListeners() {
            const tableBody = document.getElementById('admin-referrals-table-body');
            tableBody.querySelectorAll('input, select').forEach(el => {
                el.addEventListener('change', handleInputChange);
            });
        }
        
        function handleInputChange(event) {
            if (!isEditMode) return;
            const element = event.target;
            const referralId = element.dataset.id;
            const field = element.matches('.status-select') ? 'status' 
                        : element.matches('.approved-premium-input') ? 'approvedPremium'
                        : 'feeWaived';
            const value = element.type === 'checkbox' ? element.checked : (element.matches('.approved-premium-input') ? parseFloat(element.value) : element.value);

            if (!pendingReferralChanges[referralId]) {
                pendingReferralChanges[referralId] = {};
            }
            
            pendingReferralChanges[referralId][field] = value;
            document.getElementById(`ref-row-${referralId}`).classList.add('pending-changes');
        }
        
        function setupAdminPage(user) {
            document.getElementById('admin-greeting').textContent = `Welcome, ${user.displayName || user.email}!`;
            document.getElementById('admin-app').classList.remove('hidden');
            document.getElementById('auth-loader').classList.add('hidden');

            // Set up all data listeners
            onSnapshot(collection(db, "referrals"), snapshot => {
                allReferralsData = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                allReferralsData.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                displayReferrals(allReferralsData);
                // Update summary cards
                document.getElementById('pending-referrals-count').textContent = allReferralsData.filter(r => ['Pending', 'Resubmitted'].includes(r.status)).length;
                const totalOwed = allReferralsData.filter(r => r.status === 'Won' && !r.feeWaived).reduce((total, r) => total + (r.finalFindersFee || r.findersFee), 0);
                document.getElementById('finders-fee-owed-total').textContent = formatCurrency(totalOwed);
            });

            onSnapshot(collection(db, "users"), (snapshot) => {
                 allReferrers = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                 document.getElementById('total-referrers-count').textContent = allReferrers.filter(u => u.role === 'referrer').length;
            });
            
            const editBtn = document.getElementById('edit-referrals-btn');
            const saveBtn = document.getElementById('save-referrals-btn');
            const cancelBtn = document.getElementById('cancel-referrals-btn');

            editBtn.addEventListener('click', () => {
                isEditMode = true;
                editBtn.classList.add('hidden');
                saveBtn.classList.remove('hidden');
                cancelBtn.classList.remove('hidden');
                displayReferrals(allReferralsData); // Re-render to unlock fields
            });

            cancelBtn.addEventListener('click', () => {
                isEditMode = false;
                pendingReferralChanges = {};
                editBtn.classList.remove('hidden');
                saveBtn.classList.add('hidden');
                cancelBtn.classList.add('hidden');
                displayReferrals(allReferralsData); // Re-render to lock fields and remove highlights
            });

            saveBtn.addEventListener('click', async () => {
                if (Object.keys(pendingReferralChanges).length === 0) {
                    alert("No changes to save.");
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.textContent = 'Saving...';

                try {
                    const updates = Object.entries(pendingReferralChanges).map(([id, changes]) => ({
                        referralId: id,
                        ...changes
                    }));
                    
                    const processReferralUpdates = httpsCallable(functions, 'processReferralUpdates');
                    const result = await processReferralUpdates({ updates });

                    if (result.data.success) {
                        alert(`Successfully updated ${result.data.updatedCount} referral(s).`);
                    } else {
                        throw new Error(result.data.message || "An unknown error occurred.");
                    }

                    isEditMode = false;
                    pendingReferralChanges = {};
                    editBtn.classList.remove('hidden');
                    saveBtn.classList.add('hidden');
                    cancelBtn.classList.add('hidden');
                    
                } catch (error) {
                    console.error("Error saving referral changes:", error);
                    alert(`Failed to save changes: ${error.message}`);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                signOut(auth).then(() => window.location.reload());
            });
        }
        
        function showAccessDenied() {
            const loaderEl = document.getElementById('auth-loader');
            loaderEl.innerHTML = `<div class="text-center"><i class="fas fa-gavel text-5xl text-red-500 mx-auto mb-4"></i><h3 class="text-xl font-bold leading-6 mb-2">Access Denied</h3><p class="text-[var(--text-secondary)]">You do not have permission to view this page.</p><div class="mt-6"><a href="./index.html" class="button-base primary-btn py-2 px-4">Go to Login</a></div></div>`;
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userDoc = await getDoc(doc(db, "users", user.uid));
                if (userDoc.exists() && userDoc.data().role === 'admin') {
                    setupAdminPage(user);
                } else {
                    showAccessDenied();
                }
            } else {
                showAccessDenied();
            }
        });

    </script>
</body>
</html>
