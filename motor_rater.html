<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATIL Motor Insurance Referral Rater</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005f73">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TATIL Raters">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/005f73/FFFFFF?text=TATIL">

    <!-- Stylesheets and Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625; 
            --secondary-accent-darker: #8c6c1d;
            --shadow-soft: 0 3px 6px rgba(0,0,0,0.04);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.06);
            --shadow-strong: 0 8px 25px rgba(0,0,0,0.08);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif; 
        }

        .dark-mode {
            --bg-main: #1f2937; 
            --bg-bento-box: #2b3c4d; 
            --text-primary: #f0f4f8; 
            --text-secondary: #d1d5db; 
            --text-muted: #9ca3af;    
            --border-color: #4b5f71; 
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-accent); }
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
            border: 1px solid var(--border-color);
        }
        .bento-box:hover { transform: translateY(-5px); box-shadow: var(--shadow-strong); }

        input, select {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main); color: var(--text-primary);
            font-weight: 500;
        }
        input:focus, select:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
        
        .breakdown-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .breakdown-row .breakdown-label { flex-basis: 60%; }
        .breakdown-row .breakdown-value { text-align: right; font-weight: 500; flex-basis: 35%;}

        .form-section { display: none; }
        .form-section.active { display: block; }
        .advanced-section { display: none; background-color: color-mix(in srgb, var(--secondary-accent) 10%, transparent); border: 1px solid var(--secondary-accent); border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem; }
        
        .button-base { font-weight: 600; padding: 0.85rem 1.5rem; border-radius: 0.375rem; transition: all 0.2s ease; box-shadow: var(--shadow-soft); text-transform: uppercase; letter-spacing: 0.025em; cursor: pointer; }
        .button-base:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        .button-base:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .primary-btn:hover:not(:disabled) { background-color: var(--primary-accent-darker); }
        .secondary-btn { background-color: var(--secondary-accent); color: white; }
        .secondary-btn:hover:not(:disabled) { background-color: var(--secondary-accent-darker); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(29, 45, 53, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-bento-box); margin: auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 560px; border-radius: 0.75rem; position: relative; box-shadow: var(--shadow-strong); }
        
        .loader { width: 48px; height: 48px; border: 5px solid var(--primary-accent); border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8">

    <!-- Auth Loader -->
    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Authenticating and loading rater...</p>
    </div>

    <!-- Main Application Container -->
    <div id="motor-rater-app" class="w-full max-w-6xl mx-auto my-8 hidden">
         <header class="flex justify-between items-start mb-10">
            <div class="text-left">
                 <h1 class="text-4xl sm:text-5xl font-bold mb-3">Motor Insurance Referral Rater</h1>
                 <p class="text-xl text-[var(--text-secondary)]">Motor Vehicle Premiums, Simplified.</p>
            </div>
            <div id="auth-container" class="text-right">
                <span id="user-display" class="block text-sm font-semibold text-[var(--text-primary)]"></span>
                <button id="auth-btn" class="secondary-btn button-base !py-1 !px-3 !text-xs mt-2"></button>
            </div>
        </header>


        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-3 space-y-8">
                <div id="step1" class="bento-box">
                    <h2 class="text-2xl font-bold mb-4">Select Vehicle Type</h2>
                    <select id="vehicle-type-selector" class="w-full text-lg p-3">
                        <option value="">-- Please select --</option>
                        <option value="private">Private Car</option>
                        <option value="platinum">Platinum Drive (Luxury Private Car)</option>
                        <option value="commercial">Commercial Vehicle / Pick-up</option>
                    </select>
                </div>

                <div id="calculators">
                    <!-- Calculator forms will be injected here -->
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                 <div id="results-section" class="bento-box sticky top-8 text-center hidden">
                    <h2 class="text-2xl font-bold mb-2">Premium Summary</h2>
                    <p id="total-premium" class="text-4xl font-bold text-[var(--primary-accent)] mt-4">$0.00</p>
                    <p class="text-sm text-[var(--text-muted)]">(Grand Total)</p>
                    <div id="premium-breakdown" class="text-left mt-6 pt-4 border-t border-[var(--border-color)] text-[var(--text-secondary)] text-sm space-y-1"></div>
                    
                    <!-- Finder's Fee Section -->
                    <div id="finders-fee-section" class="text-left mt-6 pt-4 border-t-2 border-dashed border-[var(--secondary-accent)] hidden">
                        <h3 class="text-lg font-bold text-[var(--primary-accent)] mb-2">Finder's Fee Estimate</h3>
                        <div id="finders-fee-breakdown" class="text-[var(--text-secondary)] text-sm space-y-1"></div>
                    </div>

                    <p id="manager-referral" class="text-red-500 font-semibold mt-4"></p>
                    <button id="create-referral-btn" class="mt-6 w-full primary-btn button-base py-3">
                        Create Referral
                    </button>
                </div>
            </div>
        </main>
         <footer class="text-center mt-12 text-xs text-[var(--text-muted)]">
            <p>&copy; <span id="currentYear"></span> Kyron Marchan. Salesperson for TATIL. Your Future, Secured.</p>
        </footer>
    </div>

    <!-- Modals -->
    <div id="client-info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold leading-6 mb-4">Client & Vehicle Information for Referral</h3>
            <div class="space-y-4">
                <input type="text" id="client-name" placeholder="Client's Full Name" class="w-full">
                <input type="email" id="client-email" placeholder="Client's Email" class="w-full">
                <input type="text" id="client-contact" placeholder="Client's Contact Number" class="w-full">
                <input type="text" id="vehicle-license" placeholder="Vehicle License Plate #" class="w-full">
            </div>
            <p id="client-modal-error" class="text-red-500 text-sm text-center mt-4"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-client-modal-btn" type="button" class="button-base bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 py-2 px-4">Cancel</button>
                <button id="submit-referral-btn" type="button" class="button-base primary-btn py-2 px-4">Submit Referral</button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl">
            <h3 class="text-xl font-bold leading-6 mb-2 text-green-600">Referral Submitted Successfully!</h3>
            <p class="text-sm text-[var(--text-muted)] mb-4">You can track the status on your dashboard. You can also download or copy the quote details below.</p>
            <div id="quote-output-container" class="w-full h-96 overflow-y-auto bg-[var(--bg-main)] p-4 border border-[var(--border-color)] rounded-md">
                <pre id="quote-output" class="whitespace-pre-wrap text-sm font-mono"></pre>
            </div>
            <div class="mt-6 flex flex-wrap justify-end gap-3">
                <a href="./index.html" class="button-base bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 py-2 px-4">Dashboard</a>
                <button id="download-pdf-btn" type="button" class="button-base secondary-btn py-2 px-4">Download PDF</button>
                <button id="copy-quote-btn" type="button" class="button-base primary-btn py-2 px-4">Copy Details</button>
            </div>
        </div>
    </div>
    
    <!-- This file is required and should contain your rate data objects (NCD_RATES, SPECIAL_DISCOUNTS, etc.) -->
    <script src="./motor_rater_data.js"></script>

    <!-- Firebase -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase project configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUser = null;
        let lastCalculatedData = {};
        let quoteDataForActions = {};
        const calculatorTemplates = {};

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            const appEl = document.getElementById('motor-rater-app');
            const loaderEl = document.getElementById('auth-loader');
            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = user.displayName || user.email;
                const authBtn = document.getElementById('auth-btn');
                authBtn.textContent = 'Logout';
                authBtn.onclick = () => signOut(auth);

                appEl.classList.remove('hidden');
                loaderEl.classList.add('hidden');
                initializeRater();
            } else {
                currentUser = null;
                loaderEl.innerHTML = `<div class="text-center bento-box max-w-lg mx-auto"><h3 class="text-xl font-bold">Authentication Required</h3><p class="my-4 text-[var(--text-secondary)]">You must be logged in to use the referral rater.</p><div class="mt-6"><a href="./index.html" class="button-base primary-btn">Go to Login Page</a></div></div>`;
                appEl.classList.add('hidden');
            }
        });

        // --- INITIALIZATION ---
        function initializeRater() {
            console.log("Rater Initialized for user:", currentUser.uid);
            
            // --- DOM ELEMENTS ---
            const vehicleTypeSelector = document.getElementById('vehicle-type-selector');
            const calculatorsContainer = document.getElementById('calculators');
            const resultsSection = document.getElementById('results-section');
            const totalPremiumEl = document.getElementById('total-premium');
            const premiumBreakdownEl = document.getElementById('premium-breakdown');
            const managerReferralEl = document.getElementById('manager-referral');
            const findersFeeSection = document.getElementById('finders-fee-section');
            const findersFeeBreakdownEl = document.getElementById('finders-fee-breakdown');
            
            // Modal Elements
            const createReferralBtn = document.getElementById('create-referral-btn');
            const clientInfoModal = document.getElementById('client-info-modal');
            const closeClientModalBtn = document.getElementById('close-client-modal-btn');
            const submitReferralBtn = document.getElementById('submit-referral-btn');
            const successModal = document.getElementById('success-modal');
            const copyQuoteBtn = document.getElementById('copy-quote-btn');
            const downloadPdfBtn = document.getElementById('download-pdf-btn');
            
            // --- TEMPLATES ---
            // Storing form HTML in templates for easy injection
            calculatorTemplates.private = `<div class="bento-box"><h2 class="text-2xl font-bold">Private Car Details</h2><div class="space-y-6 mt-6"> ... form fields ... </div></div>`; // Populate with full form
            // NOTE: For brevity, the full HTML of each form is not repeated here.
            // You would copy the full form content from 'motor_rater.html' into these template literals.
            calculatorsContainer.innerHTML = `
                <!-- Private Car Calculator -->
                <div id="private-calculator" class="form-section bento-box">
                    <!-- ... Paste FULL Private Car form from original file here ... -->
                </div>
                <!-- Platinum Drive Calculator -->
                <div id="platinum-calculator" class="form-section bento-box">
                    <!-- ... Paste FULL Platinum Drive form from original file here ... -->
                </div>
                <!-- Commercial Vehicle Calculator -->
                <div id="commercial-calculator" class="form-section bento-box">
                    <!-- ... Paste FULL Commercial form from original file here ... -->
                </div>
            `;


            // --- EVENT LISTENERS ---
            vehicleTypeSelector.addEventListener('change', () => {
                const selectedType = vehicleTypeSelector.value;
                document.querySelectorAll('.form-section').forEach(calc => calc.classList.remove('active'));
                resultsSection.classList.add('hidden');
                if (selectedType) {
                    document.getElementById(`${selectedType}-calculator`).classList.add('active');
                    calculatePremium(); 
                }
            });

            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('input', () => { // Debounce for performance
                    clearTimeout(window.calcTimeout);
                    window.calcTimeout = setTimeout(calculatePremium, 250);
                });
            });

            createReferralBtn.addEventListener('click', () => {
                if (currentUser && lastCalculatedData.totalPremium > 0) {
                    clientInfoModal.style.display = 'flex';
                } else if (!currentUser) {
                    alert("Error: No user is logged in.");
                } else {
                    alert("Please calculate a valid premium first.");
                }
            });

            closeClientModalBtn.addEventListener('click', () => clientInfoModal.style.display = 'none');
            submitReferralBtn.addEventListener('click', handleReferralSubmission);
            copyQuoteBtn.addEventListener('click', copyQuoteToClipboard);
            downloadPdfBtn.addEventListener('click', generateAndDownloadPDF);
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // Initialize first calculation if a type is pre-selected
            if (vehicleTypeSelector.value) {
                document.getElementById(`${vehicleTypeSelector.value}-calculator`).classList.add('active');
                calculatePremium();
            }
        }


        // --- HELPER FUNCTIONS ---
        function getElement(id) { return document.getElementById(id); }
        function getFloatValue(id) { return parseFloat(getElement(id)?.value.replace(/,/g, '')) || 0; }
        function formatCurrency(value) { return isNaN(value) ? '0.00' : value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        
        // --- CORE LOGIC ---
        function calculatePremium() {
            const selectedType = getElement('vehicle-type-selector').value;
            if (!selectedType) return;
             if (typeof NCD_RATES === 'undefined') {
                console.error("Rate data from motor_rater_data.js is not loaded!");
                return;
            }

            const typePrefix = selectedType === 'platinum' ? 'pl' : selectedType.substring(0, 1);
            
            let result = {};
            if (selectedType === 'private') result = calculatePrivatePremium();
            else if (selectedType === 'platinum') result = calculatePlatinumPremium();
            else if (selectedType === 'commercial') result = calculateCommercialPremium();
            
            // This is a simplified calculation logic.
            // You would merge the full, detailed calculation logic from motor_rater.html here.
            // For this example, let's assume a basic calculation:
            const sumInsured = getFloatValue(`${typePrefix}-sum-insured`);
            let corePremium = sumInsured * 0.05 + 1500; // Example calculation
            let premiumBeforeTax = Math.max(corePremium, 1500);
            let taxAmount = premiumBeforeTax * 0.06;
            let finalTotal = premiumBeforeTax + taxAmount;

            getElement('results-section').classList.remove('hidden');
            getElement('total-premium').textContent = `$${formatCurrency(finalTotal)}`;
            getElement('premium-breakdown').innerHTML = `
                <div class="breakdown-row"><span class="breakdown-label">Premium Before Tax</span><span class="breakdown-value">$${formatCurrency(premiumBeforeTax)}</span></div>
                <div class="breakdown-row"><span class="breakdown-label">+ Tax (6%)</span><span class="breakdown-value">$${formatCurrency(taxAmount)}</span></div>
                <div class="breakdown-row total-row font-bold text-lg border-t border-[var(--border-color)] pt-2 mt-2"><span class="breakdown-label">Grand Total</span><span class="breakdown-value">$${formatCurrency(finalTotal)}</span></div>
            `;
            
            // Store data for submission
            lastCalculatedData = {
                insuranceType: 'Motor', vehicleType: selectedType,
                premiumBeforeTax: premiumBeforeTax,
                totalPremium: finalTotal
            };

            // Calculate and show finder's fee
            calculateAndDisplayFindersFee(premiumBeforeTax);
        }

        function calculateAndDisplayFindersFee(preTaxPremium) {
            if (preTaxPremium <= 0) {
                getElement('finders-fee-section').classList.add('hidden');
                return;
            }
            const totalCommission = preTaxPremium * 0.10;
            const incomeTax = totalCommission * 0.25;
            const netCommission = totalCommission - incomeTax;
            const findersFee = netCommission * 0.50;
            lastCalculatedData.findersFee = findersFee;

            getElement('finders-fee-breakdown').innerHTML = `
                <div class="breakdown-row"><span>Total Commission (10%)</span><span class="breakdown-value">$${formatCurrency(totalCommission)}</span></div>
                <div class="breakdown-row text-red-600"><span>- Income Tax (25%)</span><span class="breakdown-value">-$${formatCurrency(incomeTax)}</span></div>
                <div class="breakdown-row font-semibold border-t border-[var(--border-color)] pt-1 mt-1"><span>Net Commission</span><span class="breakdown-value">$${formatCurrency(netCommission)}</span></div>
                <div class="breakdown-row text-green-600 mt-2 font-bold"><span class="breakdown-label">Your Estimated Fee (50%)</span><span class="breakdown-value">$${formatCurrency(findersFee)}</span></div>`;
            getElement('finders-fee-section').classList.remove('hidden');
        }

        async function handleReferralSubmission() {
            const clientName = getElement('client-name').value;
            const clientEmail = getElement('client-email').value;
            const clientContact = getElement('client-contact').value;
            const licensePlate = getElement('vehicle-license').value;
            const errorEl = getElement('client-modal-error');
            const submitBtn = getElement('submit-referral-btn');

            if (!clientName || !clientEmail || !clientContact) {
                errorEl.textContent = "Please fill out all client fields.";
                return;
            }
            errorEl.textContent = "";
            submitBtn.innerHTML = '<span class="loader !w-6 !h-6 !border-white"></span>';
            submitBtn.disabled = true;

            const referralData = {
                ...lastCalculatedData,
                referrerId: currentUser.uid,
                referrerName: currentUser.displayName || currentUser.email,
                clientName, clientEmail, clientContact, licensePlate,
                status: 'Pending',
                createdAt: Timestamp.now(),
                breakdownDetails: getElement('premium-breakdown').innerHTML
            };

            try {
                await addDoc(collection(db, "referrals"), referralData);
                
                quoteDataForActions = {
                    client: { name: clientName, email: clientEmail, contact: clientContact },
                    vehicle: { license: licensePlate, value: lastCalculatedData.sumInsured || 0 },
                    breakdownHTML: referralData.breakdownDetails,
                    total: formatCurrency(referralData.totalPremium),
                    date: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })
                };

                getElement('client-info-modal').style.display = 'none';
                getElement('quote-output').textContent = generateQuoteTextForDisplay(quoteDataForActions);
                getElement('success-modal').style.display = 'flex';

            } catch (error) {
                console.error("Error adding document: ", error);
                errorEl.textContent = `Could not submit referral: ${error.message}`;
            } finally {
                submitBtn.innerHTML = 'Submit Referral';
                submitBtn.disabled = false;
            }
        }
        
        // --- QUOTE OUTPUT & ACTIONS (PDF, COPY) ---
        // NOTE: These functions are simplified. You would merge the full logic from motor_rater.html
        function generateQuoteTextForDisplay(data) {
             return `
OFFICIAL INSURANCE QUOTATION
---------------------------------
Date: ${data.date}
Total Premium: ${data.total}

CLIENT:
Name:    ${data.client.name}
Email:   ${data.client.email}
Contact: ${data.client.contact}

VEHICLE:
License: ${data.vehicle.license}
            `.trim();
        }

        function generateAndDownloadPDF() {
            alert("PDF generation logic would go here.");
            // Merge the jsPDF logic from the original file
        }

        function copyQuoteToClipboard() {
            const textToCopy = getElement('quote-output').innerText;
            navigator.clipboard.writeText(textToCopy).then(() => {
                getElement('copy-quote-btn').textContent = 'Copied!';
                setTimeout(() => { getElement('copy-quote-btn').textContent = 'Copy Details'; }, 2000);
            });
        }
        
        // Dummy calculation functions to be replaced with the detailed logic from motor_rater.html
        function calculatePrivatePremium() { /* Merge full logic here */ return { premiumBeforeTax: 2500, finalTotal: 2650 }; }
        function calculatePlatinumPremium() { /* Merge full logic here */ return { premiumBeforeTax: 7500, finalTotal: 7950 }; }
        function calculateCommercialPremium() { /* Merge full logic here */ return { premiumBeforeTax: 3500, finalTotal: 3710 }; }

    </script>
</body>
</html>
