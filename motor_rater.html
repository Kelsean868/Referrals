<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATIL Motor Insurance Premium Rater</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #f4f6f9; --bg-bento-box: #ffffff; --text-primary: #1d2d35; 
            --text-secondary: #4a5568; --text-muted: #718096; --border-color: #dce1e7; 
            --primary-accent: #005f73; --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625; --secondary-accent-darker: #8c6c1d;
            --shadow-soft: 0 3px 6px rgba(0,0,0,0.04); --shadow-medium: 0 5px 15px rgba(0,0,0,0.06);
            --font-body: 'Montserrat', sans-serif; --font-heading: 'Source Serif Pro', serif; 
        }
        body { font-family: var(--font-body); background-color: var(--bg-main); color: var(--text-primary); }
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-accent); }
        .bento-box { background-color: var(--bg-bento-box); border-radius: 0.75rem; padding: 1.75rem; box-shadow: var(--shadow-medium); border: 1px solid var(--border-color); }
        input, select { border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; background-color: var(--bg-main); color: var(--text-primary); font-weight: 500; }
        input:focus, select:focus { border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); outline: none; }
        .form-section { display: none; } .form-section.active { display: block; }
        .button-base { font-weight: 600; padding: 0.85rem 1.5rem; border-radius: 0.375rem; text-transform: uppercase; letter-spacing: 0.025em; cursor: pointer; }
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .secondary-btn { background-color: var(--secondary-accent); color: white; padding: 0.25rem 0.75rem; font-size: 0.875rem; text-transform: none;}
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(29, 45, 53, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: var(--bg-bento-box); margin: auto; padding: 2rem; width: 90%; max-width: 560px; border-radius: 0.75rem; }
        .advanced-section { display: none; background-color: color-mix(in srgb, var(--secondary-accent) 10%, transparent); border: 1px solid var(--secondary-accent); border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem; }
        .loader { width: 48px; height: 48px; border: 5px solid var(--primary-accent); border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8">

    <div class="fixed top-4 right-4 z-[101] flex items-center space-x-4">
        <a href="./index.html" class="text-sm font-semibold text-[var(--primary-accent)] hover:underline">&larr; Back to Dashboard</a>
    </div>

    <div id="motor-rater-app" class="w-full max-w-6xl mx-auto my-8 hidden">
        <header class="mb-10 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold mb-3">Motor Insurance Referral Rater</h1>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3 space-y-8">
                 <div class="bento-box">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-car-side mr-3 text-[var(--secondary-accent)]"></i>Vehicle Type</h2>
                    <select id="vehicle-type-selector" class="w-full text-lg p-3">
                        <option value="">-- Please select --</option>
                        <option value="private">Private Car</option>
                        <option value="platinum">Platinum Drive</option>
                        <option value="commercial">Commercial Vehicle</option>
                    </select>
                </div>
                <div id="calculators"></div>
            </div>

            <div class="lg:col-span-2">
                <div id="results-section" class="bento-box sticky top-8 text-center hidden">
                    <h2 class="text-2xl font-bold mb-2"><i class="fas fa-receipt mr-3 text-[var(--secondary-accent)]"></i>Premium Summary</h2>
                    <p id="total-premium" class="text-4xl font-bold text-[var(--primary-accent)] mt-4">$0.00</p>
                    <p class="text-sm text-[var(--text-muted)]">(Grand Total)</p>
                    <div id="premium-breakdown" class="text-left mt-6 pt-4 border-t text-sm space-y-1"></div>
                    <p id="manager-referral" class="text-red-500 font-semibold mt-4"></p>
                    <div id="finders-fee-section" class="text-left mt-6 pt-4 border-t-2 border-dashed border-[var(--secondary-accent)]">
                        <h3 class="text-lg font-bold text-[var(--primary-accent)] mb-2">Initial Finder's Fee</h3>
                        <div id="finders-fee-breakdown" class="text-[var(--text-secondary)] text-sm space-y-1"></div>
                    </div>
                    <button id="create-referral-btn" class="mt-8 w-full primary-btn button-base">Create Referral</button>
                </div>
            </div>
        </main>
    </div>
    
    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Authenticating...</p>
    </div>

    <div id="client-info-modal" class="modal-overlay hidden"><div class="modal-content"><h3 class="text-xl font-bold mb-4">Client Information</h3><div class="space-y-4"><input type="text" id="client-name" placeholder="Client's Full Name" class="w-full" required><input type="email" id="client-email" placeholder="Client's Email" class="w-full" required><input type="text" id="client-contact" placeholder="Client's Contact Number" class="w-full" required></div><p id="client-modal-error" class="text-red-500 text-sm text-center mt-4"></p><div class="mt-6 flex justify-end gap-3"><button type="button" id="close-client-modal-btn" class="button-base bg-gray-200 text-gray-700">Cancel</button><button type="button" id="submit-referral-btn" class="button-base primary-btn">Submit</button></div></div></div>
    <div id="success-modal" class="modal-overlay hidden"><div class="modal-content text-center"><i class="fas fa-check-circle text-5xl text-green-500 mx-auto mb-4"></i><h3 class="text-xl font-bold mb-2">Referral Submitted!</h3><p>You can track its status on your dashboard.</p><div class="mt-6"><a href="./index.html" class="button-base primary-btn">Dashboard</a></div></div></div>

    <script src="./motor_rater_data.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let lastCalculatedData = {};
        let calculatorTemplates = {};
        
        async function setupTemplates() {
            // Using embedded HTML for reliability instead of fetching
            calculatorTemplates = {
                private: `<div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Private Car Details</h2><label for="p-advanced-mode-check" class="flex items-center cursor-pointer"><span class="mr-3 text-sm font-medium">Advanced Mode</span><div class="relative"><input type="checkbox" id="p-advanced-mode-check" class="sr-only peer"><div class="block bg-gray-300 w-12 h-6 rounded-full peer-checked:bg-[var(--primary-accent)]"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition peer-checked:translate-x-6"></div></div></label></div><div id="p-advanced-section" class="advanced-section"><h4 class="font-semibold">Manual Rate Override</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="p-override-rate" class="block text-sm mb-1">Custom Rate (%)</label><input type="number" id="p-override-rate" class="w-full" placeholder="e.g., 7.5"></div><fieldset class="space-y-1"><legend class="text-sm">Rate Includes:</legend><div class="flex items-center"><input type="checkbox" id="p-adv-inc-base" checked><label for="p-adv-inc-base" class="ml-2 text-sm">Base</label></div><div class="flex items-center"><input type="checkbox" id="p-adv-inc-ncd" checked><label for="p-adv-inc-ncd" class="ml-2 text-sm">NCD</label></div><div class="flex items-center"><input type="checkbox" id="p-adv-inc-age-exp"><label for="p-adv-inc-age-exp" class="ml-2 text-sm">Loadings</label></div></fieldset></div></div><div class="space-y-6 mt-6"><h3 class="text-lg font-bold text-[var(--text-secondary)]">Vehicle Information</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="p-sum-insured">Sum Insured ($)</label><input type="text" inputmode="numeric" id="p-sum-insured" class="mt-1 w-full" placeholder="e.g., 80,000"></div><div><label for="p-vehicle-age">Vehicle Age</label><input type="number" id="p-vehicle-age" class="mt-1 w-full" placeholder="e.g., 5"></div><div><label for="p-coverage-type">Coverage</label><select id="p-coverage-type" class="mt-1 w-full"><option value="comprehensive">Comprehensive</option><option value="third-party">Third Party</option></select></div><div><label for="p-engine-cc">Engine</label><select id="p-engine-cc" class="mt-1 w-full"><option value="under-2000">Under 2000cc</option><option value="over-2000">Over 2000cc</option></select></div></div><h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6">Driver Details</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label for="p-driver-age">Driver's Age</label><input type="number" id="p-driver-age" class="mt-1 w-full" placeholder="e.g., 35"></div><div><label for="p-driving-exp">Experience</label><input type="number" id="p-driving-exp" class="mt-1 w-full" placeholder="e.g., 10"></div></div><h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6">Discounts</h3><div><label for="p-ncd">No Claim Discount</label><select id="p-ncd" class="mt-1 w-full"><option value="0">0 Years</option><option value="1">1 Year</option><option value="2">2 Years</option><option value="3">3 Years</option><option value="4">4+ Years</option></select></div><h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6">Optional Benefits</h3><div class="space-y-4"><div class="flex items-center"><input id="p-windscreen-check" type="checkbox"><label for="p-windscreen-check" class="ml-3">Windscreen Cover</label><input type="text" inputmode="numeric" id="p-windscreen-value" class="ml-auto w-40" placeholder="Total Value ($)" disabled></div><div id="p-woe-container"><input id="p-woe-check" type="checkbox"><label id="p-woe-label" class="ml-3">Waiver of Excess</label></div><div id="p-lou-container"><input id="p-lou-check" type="checkbox"><label class="ml-3">Loss of Use</label></div><div id="p-pa-container"><input id="p-pa-check" type="checkbox"><label id="p-pa-label" class="ml-3">Personal Accident</label></div></div></div>`,
                platinum: `...`, // Full HTML for platinum
                commercial: `...` // Full HTML for commercial
            };
        }
        
        onAuthStateChanged(auth, async (user) => {
            const appEl = document.getElementById('motor-rater-app');
            const loaderEl = document.getElementById('auth-loader');
            if (user) {
                currentUser = user;
                await setupTemplates(); // Set up templates first
                appEl.classList.remove('hidden');
                loaderEl.classList.add('hidden');
            } else {
                loaderEl.innerHTML = `<div class="text-center bento-box max-w-lg mx-auto"><h3 class="text-xl font-bold">Auth Error</h3><p>You must be logged in.</p><div class="mt-6"><a href="./index.html" class="button-base primary-btn">Login</a></div></div>`;
                appEl.classList.add('hidden');
            }
        });

        const vehicleTypeSelector = document.getElementById('vehicle-type-selector');
        const calculatorsContainer = document.getElementById('calculators');
        const resultsSection = document.getElementById('results-section');
        const totalPremiumEl = document.getElementById('total-premium');
        const premiumBreakdownEl = document.getElementById('premium-breakdown');
        const managerReferralEl = document.getElementById('manager-referral');
        const findersFeeBreakdownEl = document.getElementById('finders-fee-breakdown');
        const createReferralBtn = document.getElementById('create-referral-btn');
        const clientInfoModal = document.getElementById('client-info-modal');
        const closeModalBtn = document.getElementById('close-client-modal-btn');
        const submitReferralBtn = document.getElementById('submit-referral-btn');
        const successModal = document.getElementById('success-modal');
            
        vehicleTypeSelector.addEventListener('change', () => {
            const selectedType = vehicleTypeSelector.value;
            calculatorsContainer.innerHTML = selectedType ? `<div id="${selectedType}-calculator" class="form-section active bento-box">${calculatorTemplates[selectedType]}</div>` : '';
            if (selectedType) {
                attachEventListeners();
                calculatePremium();
            }
            resultsSection.classList.add('hidden');
        });
        
        function attachEventListeners() {
            document.querySelectorAll(`#calculators input, #calculators select`).forEach(input => {
                input.addEventListener('change', calculatePremium);
                input.addEventListener('input', () => { // Use input for immediate feedback
                    // Debounce calculation to prevent lag on sliders/fast typing
                    clearTimeout(window.calcTimeout);
                    window.calcTimeout = setTimeout(calculatePremium, 300);
                });
            });
            const prefix = vehicleTypeSelector.value.substring(0,1);
            document.getElementById(`${prefix}-advanced-mode-check`)?.addEventListener('change', e => {
                document.getElementById(`${prefix}-advanced-section`).style.display = e.target.checked ? 'block' : 'none';
                calculatePremium();
            });
             if (typeof SPECIAL_DISCOUNTS !== 'undefined') {
                Object.values(SPECIAL_DISCOUNTS).forEach(id => {
                    const check = document.getElementById(`${prefix}-${id}-check`);
                    if(check) check.addEventListener('change', e => {
                        const valueInput = document.getElementById(`${prefix}-${id}-value`);
                        if(valueInput) valueInput.disabled = !e.target.checked;
                        calculatePremium();
                    });
                });
             }
             document.getElementById(`${prefix}-windscreen-check`)?.addEventListener('change', e => {
                document.getElementById(`${prefix}-windscreen-value`).disabled = !e.target.checked;
             });
        }

        createReferralBtn.addEventListener('click', () => {
            if (lastCalculatedData.totalPremium > 0) clientInfoModal.style.display = 'flex';
            else alert("Please calculate a premium first.");
        });

        closeModalBtn.addEventListener('click', () => clientInfoModal.style.display = 'none');
        submitReferralBtn.addEventListener('click', submitReferral);

        function getFloat(id) {
            const el = document.getElementById(id);
            return el ? parseFloat((el.value || '0').replace(/,/g, '')) : 0;
        }

        function getVal(id) {
            const el = document.getElementById(id);
            return el ? el.value : '';
        }

        function isChecked(id) {
            const el = document.getElementById(id);
            return el ? el.checked : false;
        }

        function formatCurrency(value) {
            return isNaN(value) ? '$0.00' : value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
        
        function calculatePremium() {
            const selectedType = vehicleTypeSelector.value;
            if (!selectedType) return;
            resultsSection.classList.remove('hidden');

            let result = { finalTotal: 0, premiumBeforeTax: 0, htmlBreakdown: '', referralMessage: '' };
            if (selectedType === 'private') result = calculatePrivatePremium();
            // Implement other calculator functions here, using the same pattern
            
            totalPremiumEl.textContent = formatCurrency(result.finalTotal);
            premiumBreakdownEl.innerHTML = result.htmlBreakdown;
            managerReferralEl.textContent = result.referralMessage;

            lastCalculatedData = {
                insuranceType: 'Motor', vehicleType: selectedType,
                premiumBeforeTax: result.premiumBeforeTax,
                totalPremium: result.finalTotal
            };
            calculateAndDisplayFindersFee(result.premiumBeforeTax);
        }
        
        function calculateAndDisplayFindersFee(preTaxPremium) {
            const totalCommission = preTaxPremium * 0.10;
            const incomeTax = totalCommission * 0.25;
            const netCommission = totalCommission - incomeTax;
            const findersFee = netCommission * 0.50;
            lastCalculatedData.findersFee = findersFee;
            findersFeeBreakdownEl.innerHTML = `
                <div class="breakdown-row"><span>Total Commission (10%)</span><span class="font-semibold">${formatCurrency(totalCommission)}</span></div>
                <div class="breakdown-row text-red-600"><span>- Income Tax (25%)</span><span>-${formatCurrency(incomeTax)}</span></div>
                <div class="breakdown-row font-semibold border-t pt-1 mt-1"><span>Net Commission</span><span>${formatCurrency(netCommission)}</span></div>
                <div class="breakdown-row text-green-600 mt-2"><span class="font-bold">Your Finder's Fee (50%)</span><span class="font-bold">${formatCurrency(findersFee)}</span></div>`;
        }
        
        function calculatePrivatePremium() {
            const sumInsured = getFloat('p-sum-insured');
            const coverage = getVal('p-coverage-type');
            const engine = getVal('p-engine-cc');
            const driverAge = getFloat('p-driver-age');
            const ncdYears = parseInt(getVal('p-ncd') || 0);

            let corePremium = (engine === 'under-2000' ? 1700 : 2000);
            if (coverage === 'comprehensive') corePremium += sumInsured * 0.08;

            let ageLoadingRate = 0;
            if (driverAge > 0 && driverAge <= 24) ageLoadingRate = 0.20;
            const ageLoading = corePremium * ageLoadingRate;
            const premiumAfterLoading = corePremium + ageLoading;
            
            const ncdRate = NCD_RATES.private[coverage][ncdYears] || 0;
            const ncdAmount = premiumAfterLoading * ncdRate;
            let premiumAfterDiscounts = premiumAfterLoading - ncdAmount;
            
            if(isChecked('p-ansa-staff-check')) premiumAfterDiscounts *= 0.9;
            if(isChecked('p-other-motor-check')) premiumAfterDiscounts *= 0.9;
            if(isChecked('p-multi-client-check')) premiumAfterDiscounts *= 0.85;

            let optionalPremiums = 0;
            if(isChecked('p-windscreen-check')) {
                const val = getFloat('p-windscreen-value');
                if(val > 5000) optionalPremiums += (val - 5000) * 0.10;
            }
            if(isChecked('p-lou-check')) optionalPremiums += 400;

            const premiumBeforeTax = premiumAfterDiscounts + optionalPremiums;
            const taxAmount = (driverAge > 0 && driverAge <= 60) ? premiumBeforeTax * 0.06 : 0;
            const finalTotal = premiumBeforeTax + taxAmount;
            
            let htmlBreakdown = `<div class="breakdown-row"><span>Base Premium</span> <span>${formatCurrency(corePremium)}</span></div>`;
             if(ageLoading > 0) htmlBreakdown += `<div class="breakdown-row"><span>Age Loading</span> <span>+${formatCurrency(ageLoading)}</span></div>`;
             if(ncdAmount > 0) htmlBreakdown += `<div class="breakdown-row text-green-600"><span>NCD Discount</span> <span>-${formatCurrency(ncdAmount)}</span></div>`;
             htmlBreakdown += `<div class="breakdown-row font-semibold border-t mt-1 pt-1"><span>Subtotal</span> <span>${formatCurrency(premiumAfterDiscounts)}</span></div>`;
             if(optionalPremiums > 0) htmlBreakdown += `<div class="breakdown-row"><span>Optional Benefits</span> <span>+${formatCurrency(optionalPremiums)}</span></div>`;
             htmlBreakdown += `<div class="breakdown-row font-semibold"><span>Premium Before Tax</span> <span>${formatCurrency(premiumBeforeTax)}</span></div>`;
             if(taxAmount > 0) htmlBreakdown += `<div class="breakdown-row"><span>Tax (6%)</span> <span>+${formatCurrency(taxAmount)}</span></div>`;

            return { finalTotal, premiumBeforeTax, htmlBreakdown, referralMessage: '' };
        }

        async function submitReferral() {
            const clientName = document.getElementById('client-name').value;
            const clientEmail = document.getElementById('client-email').value;
            const clientContact = document.getElementById('client-contact').value;
            if (!clientName || !clientEmail || !clientContact) {
                document.getElementById('client-modal-error').textContent = "Please fill out all client fields.";
                return;
            }
            submitReferralBtn.innerHTML = '<span class="loader !w-6 !h-6"></span>';
            submitReferralBtn.disabled = true;

            try {
                await addDoc(collection(db, "referrals"), {
                    ...lastCalculatedData,
                    referrerId: currentUser.uid, referrerName: currentUser.displayName,
                    clientName, clientEmail, clientContact,
                    status: 'Pending', createdAt: Timestamp.now()
                });
                clientInfoModal.style.display = 'none';
                successModal.style.display = 'flex';
            } catch (error) {
                document.getElementById('client-modal-error').textContent = "Could not submit referral.";
            } finally {
                submitReferralBtn.innerHTML = 'Submit Referral';
                submitReferralBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
