<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATIL Motor Insurance Referral Rater</title>
    
    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005f73">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="TATIL Raters">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/005f73/FFFFFF?text=TATIL">

    <!-- Stylesheets and Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625; 
            --secondary-accent-darker: #8c6c1d;
            --shadow-soft: 0 3px 6px rgba(0,0,0,0.04);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.06);
            --shadow-strong: 0 8px 25px rgba(0,0,0,0.08);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif; 
        }

        .dark-mode {
            --bg-main: #1f2937; 
            --bg-bento-box: #2b3c4d; 
            --text-primary: #f0f4f8; 
            --text-secondary: #d1d5db; 
            --text-muted: #9ca3af;    
            --border-color: #4b5f71; 
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-accent); }
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
            border: 1px solid var(--border-color);
        }
        .bento-box:hover { transform: translateY(-5px); box-shadow: var(--shadow-strong); }

        input, select {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main); color: var(--text-primary);
            font-weight: 500;
        }
        input:focus, select:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
        
        .breakdown-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; padding: 0.125rem 0; }
        .breakdown-row .breakdown-label { flex-basis: 60%; }
        .breakdown-row .breakdown-value { text-align: right; font-weight: 500; flex-basis: 35%;}

        .form-section { display: none; }
        .form-section.active { display: block; }
        .advanced-section { display: none; background-color: color-mix(in srgb, var(--secondary-accent) 10%, transparent); border: 1px solid var(--secondary-accent); border-radius: 0.5rem; padding: 1rem; margin-top: 1.5rem; }
        
        .button-base { font-weight: 600; padding: 0.85rem 1.5rem; border-radius: 0.375rem; transition: all 0.2s ease; box-shadow: var(--shadow-soft); text-transform: uppercase; letter-spacing: 0.025em; cursor: pointer; }
        .button-base:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        .button-base:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .primary-btn:hover:not(:disabled) { background-color: var(--primary-accent-darker); }
        .secondary-btn { background-color: var(--secondary-accent); color: white; }
        .secondary-btn:hover:not(:disabled) { background-color: var(--secondary-accent-darker); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(29, 45, 53, 0.7); display: flex; align-items: center; justify-content: center; z-index: 50; backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--bg-bento-box); margin: auto; padding: 2rem; border: 1px solid var(--border-color); width: 90%; max-width: 560px; border-radius: 0.75rem; position: relative; box-shadow: var(--shadow-strong); }
        
        .loader { width: 48px; height: 48px; border: 5px solid var(--primary-accent); border-bottom-color: transparent; border-radius: 50%; display: inline-block; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8">

    <!-- Auth Loader -->
    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Authenticating and loading rater...</p>
    </div>

    <!-- Main Application Container -->
    <div id="motor-rater-app" class="w-full max-w-6xl mx-auto my-8 hidden">
         <header class="flex justify-between items-start mb-10">
            <div class="text-left">
                 <h1 class="text-4xl sm:text-5xl font-bold mb-3">Motor Insurance Referral Rater</h1>
                 <p class="text-xl text-[var(--text-secondary)]">Motor Vehicle Premiums, Simplified.</p>
            </div>
            <div id="auth-container" class="text-right">
                <a href="./index.html" class="text-sm font-semibold text-[var(--primary-accent)] hover:underline block mb-2">&larr; Back to Dashboard</a>
                <span id="user-display" class="block text-sm font-semibold text-[var(--text-primary)]"></span>
                <button id="auth-btn" class="secondary-btn button-base !py-1 !px-3 !text-xs mt-2"></button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <!-- Left Column: Inputs -->
            <div class="lg:col-span-3 space-y-8">
                <div id="step1" class="bento-box">
                    <h2 class="text-2xl font-bold mb-4">Select Vehicle Type</h2>
                    <select id="vehicle-type-selector" class="w-full text-lg p-3">
                        <option value="">-- Please select --</option>
                        <option value="private">Private Car</option>
                        <option value="platinum">Platinum Drive (Luxury Private Car)</option>
                        <option value="commercial">Commercial Vehicle / Pick-up</option>
                    </select>
                </div>

                <div id="calculators">
                    <!-- Calculator forms will be injected here by JS -->
                </div>
            </div>

            <!-- Right Column: Results -->
            <div class="lg:col-span-2">
                 <div id="results-section" class="bento-box sticky top-8 text-center hidden">
                    <h2 class="text-2xl font-bold mb-2">Premium Summary</h2>
                    <p id="total-premium" class="text-4xl font-bold text-[var(--primary-accent)] mt-4">$0.00</p>
                    <p class="text-sm text-[var(--text-muted)]">(Grand Total)</p>
                    <div id="premium-breakdown" class="text-left mt-6 pt-4 border-t border-[var(--border-color)] text-[var(--text-secondary)] text-sm space-y-1"></div>
                    
                    <div id="finders-fee-section" class="text-left mt-6 pt-4 border-t-2 border-dashed border-[var(--secondary-accent)] hidden">
                        <h3 class="text-lg font-bold text-[var(--primary-accent)] mb-2">Finder's Fee Estimate</h3>
                        <div id="finders-fee-breakdown" class="text-[var(--text-secondary)] text-sm space-y-1"></div>
                    </div>

                    <p id="manager-referral" class="text-red-500 font-semibold mt-4"></p>
                    <button id="create-referral-btn" class="mt-6 w-full primary-btn button-base py-3">
                        Create Referral
                    </button>
                </div>
            </div>
        </main>
         <footer class="text-center mt-12 text-xs text-[var(--text-muted)]">
            <p>&copy; <span id="currentYear"></span> Kyron Marchan. Salesperson for TATIL. Your Future, Secured.</p>
        </footer>
    </div>
    
    <!-- Modals -->
    <div id="client-info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold leading-6 mb-4">Client & Vehicle Information for Referral</h3>
            <div class="space-y-4">
                <input type="text" id="client-name" placeholder="Client's Full Name" class="w-full">
                <input type="email" id="client-email" placeholder="Client's Email" class="w-full">
                <input type="text" id="client-contact" placeholder="Client's Contact Number" class="w-full">
                <input type="text" id="vehicle-license" placeholder="Vehicle License Plate #" class="w-full">
            </div>
            <p id="client-modal-error" class="text-red-500 text-sm text-center mt-4"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-client-modal-btn" type="button" class="button-base bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 py-2 px-4">Cancel</button>
                <button id="submit-referral-btn" type="button" class="button-base primary-btn py-2 px-4">Submit Referral</button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-2xl">
            <h3 class="text-xl font-bold leading-6 mb-2 text-green-600">Referral Submitted Successfully!</h3>
            <p class="text-sm text-[var(--text-muted)] mb-4">You can track the status on your dashboard. You can also download or copy the quote details below.</p>
            <div id="quote-output-container" class="w-full h-96 overflow-y-auto bg-[var(--bg-main)] p-4 border border-[var(--border-color)] rounded-md">
                <pre id="quote-output" class="whitespace-pre-wrap text-sm font-mono"></pre>
            </div>
            <div class="mt-6 flex flex-wrap justify-end gap-3">
                <a href="./index.html" class="button-base bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200 py-2 px-4">Dashboard</a>
                <button id="download-pdf-btn" type="button" class="button-base secondary-btn py-2 px-4">Download PDF</button>
                <button id="copy-quote-btn" type="button" class="button-base primary-btn py-2 px-4">Copy Details</button>
            </div>
        </div>
    </div>
    
    <!-- This file is required and should contain your rate data objects (NCD_RATES, SPECIAL_DISCOUNTS, etc.) -->
    <script src="./motor_rater_data.js"></script>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let lastCalculatedData = {};
        let quoteDataForActions = {};
        // Correctly reference the jsPDF object from the global scope.
        const { jsPDF } = jspdf;

        // --- AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            const appEl = document.getElementById('motor-rater-app');
            const loaderEl = document.getElementById('auth-loader');
            if (user) {
                currentUser = user;
                document.getElementById('user-display').textContent = user.displayName || user.email;
                const authBtn = document.getElementById('auth-btn');
                authBtn.textContent = 'Logout';
                authBtn.onclick = () => signOut(auth);
                appEl.classList.remove('hidden');
                loaderEl.classList.add('hidden');
                initializeRater();
            } else {
                currentUser = null;
                loaderEl.innerHTML = `<div class="text-center bento-box max-w-lg mx-auto"><h3 class="text-xl font-bold">Authentication Required</h3><p class="my-4 text-[var(--text-secondary)]">You must be logged in to use the referral rater.</p><div class="mt-6"><a href="./index.html" class="button-base primary-btn">Go to Login Page</a></div></div>`;
                appEl.classList.add('hidden');
            }
        });

        // --- INITIALIZATION ---
        function initializeRater() {
            const calculatorsContainer = document.getElementById('calculators');
            // Inject the full HTML for each calculator form
            calculatorsContainer.innerHTML = getCalculatorHTML();
            
            // Re-query for all inputs now that they are in the DOM
            const allInputs = document.querySelectorAll('input, select');
            
            // Attach event listeners
            document.getElementById('vehicle-type-selector').addEventListener('change', handleVehicleTypeChange);
            allInputs.forEach(input => {
                input.addEventListener('input', () => {
                    clearTimeout(window.calcTimeout);
                    window.calcTimeout = setTimeout(calculatePremium, 250);
                });
                input.addEventListener('change', calculatePremium);
            });

            document.getElementById('create-referral-btn').addEventListener('click', handleCreateReferralClick);
            document.getElementById('close-client-modal-btn').addEventListener('click', () => document.getElementById('client-info-modal').style.display = 'none');
            document.getElementById('submit-referral-btn').addEventListener('click', handleReferralSubmission);
            document.getElementById('copy-quote-btn').addEventListener('click', copyQuoteToClipboard);
            document.getElementById('download-pdf-btn').addEventListener('click', generateAndDownloadPDF);
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Setup specific UI interactions
            setupUITriggers();

            // Initial calculation
            handleVehicleTypeChange();
        }

        function setupUITriggers() {
            ['p', 'pl', 'c'].forEach(prefix => {
                const advancedCheck = getElement(`${prefix}-advanced-mode-check`);
                if(advancedCheck) advancedCheck.addEventListener('change', e => {
                    getElement(`${prefix}-advanced-section`).style.display = e.target.checked ? 'block' : 'none';
                    calculatePremium();
                });
                if (typeof SPECIAL_DISCOUNTS !== 'undefined') {
                    Object.values(SPECIAL_DISCOUNTS).forEach(id => setupDiscountToggle(prefix, id));
                }
                if(getElement(`${prefix}-add-loading-btn`)) {
                    getElement(`${prefix}-add-loading-btn`).addEventListener('click', () => addExtraLoading(prefix));
                }
            });
            setupCheckboxToggle('p-windscreen-check', 'p-windscreen-value');
            setupCheckboxToggle('pl-windscreen-check', 'pl-windscreen-value');
            getElement('p-coverage-type').addEventListener('change', handlePrivateCoverageChange);
            getElement('c-coverage-type').addEventListener('change', handleCommercialCoverageChange);
            getElement('c-usage').addEventListener('change', handleCommercialUsageChange);
        }

        // --- EVENT HANDLERS ---
        function handleVehicleTypeChange() {
            const selectedType = getElement('vehicle-type-selector').value;
            document.querySelectorAll('.form-section').forEach(calc => calc.classList.remove('active'));
            getElement('results-section').classList.add('hidden');
            if (selectedType) {
                getElement(`${selectedType}-calculator`).classList.add('active');
                calculatePremium(); 
            }
        }

        function handleCreateReferralClick() {
            if (currentUser && lastCalculatedData.totalPremium > 0) {
                getElement('client-info-modal').style.display = 'flex';
            } else if (!currentUser) {
                alert("Error: No user is logged in.");
            } else {
                alert("Please calculate a valid premium first.");
            }
        }

        async function handleReferralSubmission() {
            const clientName = getElement('client-name').value;
            const clientEmail = getElement('client-email').value;
            const clientContact = getElement('client-contact').value;
            const licensePlate = getElement('vehicle-license').value;
            const errorEl = getElement('client-modal-error');
            const submitBtn = getElement('submit-referral-btn');

            if (!clientName || !clientEmail || !clientContact) {
                errorEl.textContent = "Please fill out all client fields."; return;
            }
            errorEl.textContent = "";
            submitBtn.innerHTML = '<span class="loader !w-6 !h-6 !border-white"></span>';
            submitBtn.disabled = true;

            const referralData = { ...lastCalculatedData, referrerId: currentUser.uid, referrerName: currentUser.displayName || currentUser.email, clientName, clientEmail, clientContact, licensePlate, status: 'Pending', createdAt: Timestamp.now() };

            try {
                await addDoc(collection(db, "referrals"), referralData);
                
                quoteDataForActions = {
                    client: { name: clientName, email: clientEmail, contact: clientContact, age: getFloatValue(`${lastCalculatedData.typePrefix}-driver-age`), exp: getFloatValue(`${lastCalculatedData.typePrefix}-driving-exp`) },
                    vehicle: { license: licensePlate, value: getFloatValue(`${lastCalculatedData.typePrefix}-sum-insured`), age: getFloatValue(`${lastCalculatedData.typePrefix}-vehicle-age`) },
                    breakdown: Array.from(getElement('premium-breakdown').querySelectorAll('.breakdown-row')).map(row => ({
                        label: row.children[0].innerText, value: row.children[1].innerText
                    })),
                    total: getElement('total-premium').innerText,
                    date: new Date().toLocaleDateString('en-GB', { day: '2-digit', month: 'long', year: 'numeric' })
                };

                getElement('client-info-modal').style.display = 'none';
                getElement('quote-output').textContent = generateQuoteTextForDisplay(quoteDataForActions);
                getElement('success-modal').style.display = 'flex';
            } catch (error) {
                console.error("Error adding document: ", error);
                errorEl.textContent = `Could not submit referral: ${error.message}`;
            } finally {
                submitBtn.innerHTML = 'Submit Referral';
                submitBtn.disabled = false;
            }
        }
        
        // --- HELPER & UI FUNCTIONS ---
        function getElement(id) { return document.getElementById(id); }
        function getFloatValue(id) { return parseFloat(getElement(id)?.value.replace(/,/g, '')) || 0; }
        function formatCurrency(value) { return isNaN(value) ? '0.00' : value.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function addExtraLoading(prefix) {
            const container = getElement(`${prefix}-extra-loadings-container`);
            const loadingRow = document.createElement('div');
            loadingRow.className = 'grid grid-cols-3 gap-2 items-center extra-loading-row';
            loadingRow.innerHTML = `<input type="text" placeholder="Loading Name" class="col-span-2 p-2 loading-name"><input type="number" placeholder="%" class="p-2 loading-percent">`;
            container.appendChild(loadingRow);
            loadingRow.querySelectorAll('input').forEach(input => input.addEventListener('input', calculatePremium));
        }
        
        function setupDiscountToggle(prefix, id) {
            const check = getElement(`${prefix}-${id}-check`);
            if(!check) return;
            check.addEventListener('change', e => {
                const valueInput = getElement(`${prefix}-${id}-value`);
                valueInput.disabled = !e.target.checked;
                if (!e.target.checked) valueInput.value = '';
                calculatePremium();
            });
        }
        
        function setupCheckboxToggle(checkboxId, inputId) {
            const checkbox = getElement(checkboxId);
            if (!checkbox) return;
            checkbox.addEventListener('change', (e) => {
                const input = getElement(inputId);
                input.disabled = !e.target.checked;
                if (!e.target.checked) input.value = '';
                calculatePremium();
            });
        }
        
        function handlePrivateCoverageChange() {
            const isComp = getElement('p-coverage-type').value === 'comprehensive';
            getElement('p-sum-insured-container').style.display = isComp ? 'block' : 'none';
            getElement('p-woe-container').style.display = isComp ? 'flex' : 'none';
            getElement('p-lou-container').style.display = isComp ? 'flex' : 'none';
            getElement('p-pa-label').textContent = isComp ? "Personal Accident ($200k)" : "Personal Accident ($100k)";
            if (!isComp) {
                getElement('p-woe-check').checked = false;
                getElement('p-lou-check').checked = false;
            }
        }
        
        function handleCommercialCoverageChange() {
            const isComp = getElement('c-coverage-type').value === 'comprehensive';
            getElement('c-sum-insured-container').style.display = isComp ? 'block' : 'none';
            getElement('c-usage-container').style.display = isComp ? 'block' : 'none';
            getElement('c-hp-container').style.display = isComp ? 'none' : 'block';
        }

        function handleCommercialUsageChange() {
            const isPrivatePickup = getElement('c-usage').value === 'private-pickup';
            getElement('c-private-pickup-discount-container').style.display = isPrivatePickup ? 'block' : 'none';
            if (!isPrivatePickup) getElement('c-private-pickup-discount').value = "0";
        }

        function checkWoeEligibility(prefix) {
             const age = getFloatValue(`${prefix}-driver-age`);
             const exp = getFloatValue(`${prefix}-driving-exp`);
             const woeContainer = getElement(`${prefix}-woe-container`);
             const woeCheckbox = getElement(`${prefix}-woe-check`);
             if(!woeContainer || !woeCheckbox) return;
             
             const isEligible = age >= 25 && exp >= 2;
             woeContainer.classList.toggle('opacity-50', !isEligible);
             woeCheckbox.disabled = !isEligible;
             if(!isEligible) woeCheckbox.checked = false;
        }

        // --- CORE CALCULATION LOGIC ---
        function calculatePremium() {
            const selectedType = getElement('vehicle-type-selector').value;
            if (!selectedType || typeof NCD_RATES === 'undefined') return;
            
            const typePrefix = selectedType === 'platinum' ? 'pl' : selectedType.substring(0, 1);
            if (selectedType !== 'commercial') checkWoeEligibility(typePrefix);

            let result = {};
            if (selectedType === 'private') result = calculatePrivatePremium();
            else if (selectedType === 'platinum') result = calculatePlatinumPremium();
            else if (selectedType === 'commercial') result = calculateCommercialPremium();
            
            let { corePremium, optionalPremiums, optionalBreakdown, referralMessage, excess } = result;

            const isAdvanced = getElement(`${typePrefix}-advanced-mode-check`)?.checked;
            const overrideRate = getFloatValue(`${typePrefix}-override-rate`) / 100;
            const sumInsured = getFloatValue(`${typePrefix}-sum-insured`);
            const advIncludesBase = isAdvanced && getElement(`${typePrefix}-adv-inc-base`).checked;
            const advIncludesNCD = isAdvanced && getElement(`${typePrefix}-adv-inc-ncd`).checked;
            const advIncludesAgeExp = isAdvanced && getElement(`${typePrefix}-adv-inc-age-exp`).checked;
            
            const loadingPercentages = getLoadingPercentages(selectedType, typePrefix);
            let ageLoadingAmount = corePremium * (loadingPercentages['Age'] || 0);
            let expLoadingAmount = corePremium * (loadingPercentages['Experience'] || 0);
            let occupationLoadingAmount = corePremium * (loadingPercentages['Occupation'] || 0);
            let vehicleTypeLoadingAmount = corePremium * (loadingPercentages['Vehicle Type'] || 0);
            
            let baseLabel = 'Base Premium';

            if (isAdvanced && overrideRate > 0 && sumInsured > 0) {
                let labelParts = [];
                if (advIncludesBase) labelParts.push("Base");
                if (advIncludesNCD) labelParts.push("NCD");
                if (advIncludesAgeExp) labelParts.push("Age/Exp");
                baseLabel = `Manual Rate (${labelParts.join(' + ')})`;
                corePremium = sumInsured * overrideRate;
                if (advIncludesAgeExp) {
                    ageLoadingAmount = 0; expLoadingAmount = 0;
                }
            }
            
            let loadingBreakdown = buildBreakdownHTML('+ Age Loading', loadingPercentages.Age, ageLoadingAmount) +
                                 buildBreakdownHTML('+ Experience Loading', loadingPercentages.Experience, expLoadingAmount) +
                                 buildBreakdownHTML('+ Occupation Loading', loadingPercentages.Occupation, occupationLoadingAmount) +
                                 buildBreakdownHTML('+ Vehicle Type Loading', loadingPercentages['Vehicle Type'], vehicleTypeLoadingAmount);

            let extraLoadingAmount = 0;
            getElement(`${typePrefix}-extra-loadings-container`).querySelectorAll('.extra-loading-row').forEach(row => {
                const name = row.querySelector('.loading-name').value;
                const percent = parseFloat(row.querySelector('.loading-percent').value) || 0;
                if (name && percent > 0) {
                    const amount = corePremium * (percent / 100);
                    extraLoadingAmount += amount;
                    loadingBreakdown += `<div class="breakdown-row"><span class="breakdown-label">+ ${name} (${percent}%)</span><span class="breakdown-value">$${formatCurrency(amount)}</span></div>`;
                }
            });

            const totalLoadingAmount = ageLoadingAmount + expLoadingAmount + occupationLoadingAmount + vehicleTypeLoadingAmount + extraLoadingAmount;
            const premiumAfterLoadings = corePremium + totalLoadingAmount;
            const { totalDiscountAmount, discountBreakdown } = calculateDiscounts(selectedType, typePrefix, premiumAfterLoadings, advIncludesNCD);
            
            const premiumAfterDiscounts = premiumAfterLoadings - totalDiscountAmount;
            const subtotalWithBenefits = premiumAfterDiscounts + optionalPremiums;
            
            let minPremium = 0;
            if (selectedType === 'private') minPremium = getElement('p-coverage-type').value === 'comprehensive' ? 2000 : 1150;
            else if (selectedType === 'platinum') minPremium = 7500;
            else if (selectedType === 'commercial') minPremium = getElement('c-coverage-type').value === 'comprehensive' ? 2000 : 1150;

            const premiumBeforeTax = Math.max(subtotalWithBenefits, minPremium);
            
            let taxAmount = 0;
            const driverAge = getFloatValue(`${typePrefix}-driver-age`);
            if (driverAge > 0 && driverAge <= 60) taxAmount = premiumBeforeTax * 0.06;
            
            const finalTotal = premiumBeforeTax + taxAmount;
            
            getElement('results-section').classList.remove('hidden');
            getElement('total-premium').textContent = `$${formatCurrency(finalTotal)}`;
            getElement('manager-referral').textContent = referralMessage;

            let breakdownHTML = `<div class="breakdown-row"><span class="breakdown-label">${baseLabel}</span><span class="breakdown-value">$${formatCurrency(corePremium)}</span></div>`;
            if (loadingBreakdown) breakdownHTML += loadingBreakdown + `<div class="breakdown-row font-semibold border-t border-[var(--border-color)] pt-1 mt-1"><span class="breakdown-label">Subtotal after Loadings</span><span class="breakdown-value">$${formatCurrency(premiumAfterLoadings)}</span></div>`;
            if (discountBreakdown) breakdownHTML += discountBreakdown + `<div class="breakdown-row font-semibold border-t border-[var(--border-color)] pt-1 mt-1"><span class="breakdown-label">Subtotal after Discounts</span><span class="breakdown-value">$${formatCurrency(premiumAfterDiscounts)}</span></div>`;
            if (optionalBreakdown) breakdownHTML += `<div class="border-t border-[var(--border-color)] pt-2 mt-2"><p class="font-semibold mb-1">Optional Benefits:</p>${optionalBreakdown}</div>` + `<div class="breakdown-row font-semibold border-t border-[var(--border-color)] pt-1 mt-1"><span class="breakdown-label">Premium w/ Benefits (before Tax)</span><span class="breakdown-value">$${formatCurrency(subtotalWithBenefits)}</span></div>`;
            if (premiumBeforeTax > subtotalWithBenefits && subtotalWithBenefits > 0) breakdownHTML += `<div class="breakdown-row mt-2 font-semibold"><span class="breakdown-label">Premium Before Tax (Min. Applied)</span><span class="breakdown-value">$${formatCurrency(premiumBeforeTax)}</span></div>`;
            if (driverAge > 0) breakdownHTML += `<div class="breakdown-row"><span class="breakdown-label">+ Tax (6%)</span><span class="breakdown-value">${driverAge > 60 ? '$0.00 (Exempt)' : `$${formatCurrency(taxAmount)}`}</span></div>`;
            breakdownHTML += `<div class="breakdown-row total-row font-bold text-lg border-t-2 border-[var(--primary-accent)] pt-2 mt-2"><span class="breakdown-label">Grand Total</span><span class="breakdown-value">$${formatCurrency(finalTotal)}</span></div>`;
            
            getElement('premium-breakdown').innerHTML = breakdownHTML;

            lastCalculatedData = { insuranceType: 'Motor', vehicleType: selectedType, typePrefix: typePrefix, premiumBeforeTax: premiumBeforeTax, totalPremium: finalTotal, breakdownHTML: breakdownHTML };
            calculateAndDisplayFindersFee(premiumBeforeTax);
        }
        
        function buildBreakdownHTML(label, rate, amount) {
            if (amount <= 0) return '';
            return `<div class="breakdown-row"><span class="breakdown-label">${label} (${(rate * 100)}%)</span><span class="breakdown-value">$${formatCurrency(amount)}</span></div>`;
        }

        function calculateDiscounts(type, prefix, premiumToDiscount, skipNCD) {
            let totalDiscountAmount = 0, discountBreakdown = '';
            
            if (!skipNCD) {
                const ncdYears = parseInt(getElement(`${prefix}-ncd`).value, 10);
                const coverage = (getElement(`${prefix}-coverage-type`) || {}).value || 'comprehensive';
                const ncdRate = NCD_RATES[type][coverage][ncdYears] || 0;
                if (ncdRate > 0) {
                    const amount = premiumToDiscount * ncdRate;
                    totalDiscountAmount += amount;
                    discountBreakdown += `<div class="breakdown-row text-green-600 dark:text-green-400"><span class="breakdown-label">- NCD (${(ncdRate * 100)}%)</span><span class="breakdown-value">-$${formatCurrency(amount)}</span></div>`;
                }
            }

            const standardDiscounts = {'ansa-staff': 0.10, 'other-motor': 0.10, 'multi-client': 0.15};
            Object.entries(standardDiscounts).forEach(([id, rate]) => {
                if(getElement(`${prefix}-${id}-check`)?.checked) {
                    const amount = premiumToDiscount * rate;
                    totalDiscountAmount += amount;
                    const label = id.charAt(0).toUpperCase() + id.slice(1).replace('-', ' ');
                    discountBreakdown += `<div class="breakdown-row text-green-600 dark:text-green-400"><span class="breakdown-label">- ${label} (${rate*100}%)</span><span class="breakdown-value">-$${formatCurrency(amount)}</span></div>`;
                }
            });
            
            if(prefix === 'c' && getElement('c-private-pickup-discount').value > 0){
                const rate = getFloatValue('c-private-pickup-discount');
                const amount = premiumToDiscount * rate;
                totalDiscountAmount += amount;
                discountBreakdown += `<div class="breakdown-row text-green-600 dark:text-green-400"><span class="breakdown-label">- Private Pick-Up (${rate*100}%)</span><span class="breakdown-value">-$${formatCurrency(amount)}</span></div>`;
            }
            
            let specialDiscountBreakdown = '';
            Object.entries(SPECIAL_DISCOUNTS).forEach(([label, id]) => {
                if (getElement(`${prefix}-${id}-check`)?.checked) {
                    const rate = getFloatValue(`${prefix}-${id}-value`) / 100;
                    if (rate > 0) {
                        const amount = premiumToDiscount * rate;
                        totalDiscountAmount += amount;
                        specialDiscountBreakdown += `<div class="breakdown-row text-green-600 dark:text-green-400"><span class="breakdown-label">- ${label} (${rate*100}%)</span><span class="breakdown-value">-$${formatCurrency(amount)}</span></div>`;
                    }
                }
            });
            if(specialDiscountBreakdown) discountBreakdown += `<h4 class="font-medium text-[var(--text-secondary)] mt-1">Special Discounts:</h4>${specialDiscountBreakdown}`;
            if (discountBreakdown) discountBreakdown = `<div class="border-t border-[var(--border-color)] pt-2 mt-2"><p class="font-semibold mb-1">Discounts:</p>${discountBreakdown}</div>`;

            return { totalDiscountAmount, discountBreakdown };
        }

        function getLoadingPercentages(type, prefix) {
            let loadings = { 'Age': 0, 'Experience': 0, 'Occupation': 0, 'Vehicle Type': 0 };
            const age = getFloatValue(`${prefix}-driver-age`), exp = getFloatValue(`${prefix}-driving-exp`), occupation = getElement(`${prefix}-occupation`).value, model = getElement(`${prefix}-vehicle-model`)?.value;
            const isComp = (getElement(`${prefix}-coverage-type`) || {}).value !== 'third-party';

            if (isComp) {
                if (type === 'platinum') {
                    if (age > 0 && age <= 25) loadings['Age'] = 0.50;
                    if (exp > 0 && exp < 2) loadings['Experience'] = 0.50; else if (exp === 2) loadings['Experience'] = 0.10;
                    if (['travelling', 'music', 'shift'].includes(occupation)) loadings['Occupation'] = 0.10;
                    if (occupation === 'protective') loadings['Occupation'] = 0.20;
                    if (['hybrid', 'electric'].includes(model)) loadings['Vehicle Type'] = 0.20;
                } else {
                    if (age > 0 && age <= 24) loadings['Age'] = 0.20;
                    if (exp > 0 && exp < 2) loadings['Experience'] = 0.20; else if (exp === 2) loadings['Experience'] = 0.10;
                    if (['travelling', 'music', 'shift', 'protective'].includes(occupation)) loadings['Occupation'] = 0.10;
                    if (type === 'private' && ['hybrid', 'electric', 'honda-city'].includes(model)) loadings['Vehicle Type'] = model === 'honda-city' ? 0.30 : 0.20;
                }
            } else { // Third Party
                if (age > 0 && age <= 24) loadings['Age'] = 0.50;
                if (exp > 0 && exp < 2) loadings['Experience'] = 0.50; else if (exp === 2) loadings['Experience'] = 0.10;
                if (['travelling', 'music', 'shift', 'protective'].includes(occupation)) loadings['Occupation'] = 0.25;
                 if (type === 'private' && ['hybrid', 'electric', 'honda-city'].includes(model)) loadings['Vehicle Type'] = model === 'honda-city' ? 0.30 : 0.20;
            }
            return loadings;
        }

        function calculatePrivatePremium() {
            let core = 0, optPremiums = 0, optBreakdown = '', refMsg = '', excess = 0;
            const coverage = getElement('p-coverage-type').value, engine = getElement('p-engine-cc').value, age = getFloatValue('p-driver-age'), si = getFloatValue('p-sum-insured');
            if (age > 65) refMsg = "Drivers over 65 must be referred to a manager.";
            if (coverage === 'comprehensive') {
                excess = si * 0.03;
                core = (si * 0.08) + (engine === 'under-2000' ? 1700 : 2000);
                if (getElement('p-windscreen-check').checked) { const val = getFloatValue('p-windscreen-value'); if (val > 5000) { const p = (val-5000)*0.10; optPremiums+=p; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Windscreen</span><span class="breakdown-value">$${formatCurrency(p)}</span></div>`;}}
                if (getElement('p-woe-check').checked) { const p = Math.max(excess*0.10, 400); optPremiums+=p; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Waiver of Excess</span><span class="breakdown-value">$${formatCurrency(p)}</span></div>`;}
                if (getElement('p-lou-check').checked) { optPremiums+=400; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Loss of Use</span><span class="breakdown-value">$400.00</span></div>`;}
                if (getElement('p-pa-check').checked) { optPremiums+=200; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Personal Accident</span><span class="breakdown-value">$200.00</span></div>`;}
            } else {
                core = (engine === 'under-2000' ? 1700 : 2000);
                if (getElement('p-pa-check').checked) { optPremiums+=100; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Personal Accident</span><span class="breakdown-value">$100.00</span></div>`;}
            }
            return { corePremium: core, optionalPremiums: optPremiums, optionalBreakdown: optBreakdown, referralMessage: refMsg, excess: excess };
        }

        function calculatePlatinumPremium() {
            let core = 0, optPremiums = 0, optBreakdown = '', refMsg = '', excess = 0;
            const engine = getElement('pl-engine-cc').value, age = getFloatValue('pl-driver-age'), si = getFloatValue('pl-sum-insured'), vehicleAge = getFloatValue('pl-vehicle-age');
            if (age > 65) refMsg += "Drivers over 65 must be referred.\n";
            if (si > 0 && si < 650000) refMsg += "Sum Insured must be >$650k.\n";
            if (vehicleAge > 2) refMsg += "Vehicle age >2 years requires referral.\n";
            if (getElement('pl-ncd').value !== '4') refMsg += "Max NCD is required.\n";
            excess = si * 0.03;
            core = (si * 0.035) + (engine === 'under-2000' ? 3000 : 4000);
            if (getElement('pl-windscreen-check').checked) { const val = getFloatValue('pl-windscreen-value'); if (val > 20000) { const p = (val-20000)*0.10; optPremiums+=p; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Incr. Windscreen</span><span class="breakdown-value">$${formatCurrency(p)}</span></div>`;}}
            if (getElement('pl-woe-check').checked) { const p = Math.max(excess*0.10, 1000); optPremiums+=p; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Waiver of Excess</span><span class="breakdown-value">$${formatCurrency(p)}</span></div>`;}
            if (getElement('pl-pa-check').checked) { optPremiums+=200; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Personal Accident</span><span class="breakdown-value">$200.00</span></div>`;}
            if (getElement('pl-tpl-check').checked) { optPremiums+=2500; optBreakdown+=`<div class="breakdown-row pl-4"><span class="breakdown-label">+ Increased TPL</span><span class="breakdown-value">$2,500.00</span></div>`;}
            return { corePremium: core, optionalPremiums: optPremiums, optionalBreakdown: optBreakdown, referralMessage: refMsg.trim(), excess: excess };
        }

        function calculateCommercialPremium() {
            let core = 0, excess = 0, refMsg = '';
            const coverage = getElement('c-coverage-type').value;
            if (coverage === 'comprehensive') {
                const si = getFloatValue('c-sum-insured');
                excess = si * 0.03;
                const usage = getElement('c-usage').value;
                let rate = 0.10, base = 3500;
                if (usage === 'private-pickup') { rate = 0.08; base = 1700; }
                else if (usage === 'own-goods') { rate = 0.085; base = 2200; }
                core = (si * rate) + base;
            } else {
                const hp = getElement('c-hp').value;
                let base = 3700;
                if (hp === 'upto-30') base = 2200;
                else if (hp === '31-50') base = 2700;
                core = base;
            }
            return { corePremium: core, optionalPremiums: 0, optionalBreakdown: '', referralMessage: refMsg, excess: excess };
        }

        function calculateAndDisplayFindersFee(preTaxPremium) {
            const feeSection = getElement('finders-fee-section');
            if (preTaxPremium <= 0) { feeSection.classList.add('hidden'); return; }
            const commission = preTaxPremium * 0.10;
            const tax = commission * 0.25;
            const net = commission - tax;
            const fee = net * 0.50;
            lastCalculatedData.findersFee = fee;
            getElement('finders-fee-breakdown').innerHTML = `
                <div class="breakdown-row"><span>Total Commission (10%)</span><span class="breakdown-value">$${formatCurrency(commission)}</span></div>
                <div class="breakdown-row text-red-600"><span>- Income Tax (25%)</span><span class="breakdown-value">-$${formatCurrency(tax)}</span></div>
                <div class="breakdown-row font-semibold border-t border-[var(--border-color)] pt-1 mt-1"><span>Net Commission</span><span class="breakdown-value">$${formatCurrency(net)}</span></div>
                <div class="breakdown-row text-green-600 mt-2 font-bold"><span class="breakdown-label">Your Estimated Fee (50%)</span><span class="breakdown-value">$${formatCurrency(fee)}</span></div>`;
            feeSection.classList.remove('hidden');
        }

        // --- QUOTE OUTPUT & ACTIONS ---
        function generateQuoteTextForDisplay(data) {
            let text = `=========================================\n      OFFICIAL INSURANCE QUOTATION\n=========================================\nDate: ${data.date}\n\n`;
            text += `CLIENT INFORMATION:\n-------------------\nName:               ${data.client.name}\nEmail:              ${data.client.email}\nContact:            ${data.client.contact}\nAge:                ${data.client.age || 'N/A'}\nDriving Exp:        ${data.client.exp ? `${data.client.exp} years` : 'N/A'}\n\n`;
            text += `VEHICLE INFORMATION:\n--------------------\nLicense Plate:      ${data.vehicle.license || 'N/A'}\nValue of Vehicle:   ${data.vehicle.value > 0 ? '$' + formatCurrency(data.vehicle.value) : 'N/A'}\nAge of Vehicle:     ${data.vehicle.age > 0 ? `${data.vehicle.age} years` : 'N/A'}\n\n`;
            text += `PREMIUM CALCULATION:\n--------------------\n`;
            data.breakdown.forEach(row => {
                text += `${row.label.padEnd(40, ' ')} ${row.value}\n`;
            });
            text +=`\n=========================================\n\nThis quotation is valid for 30 days. Terms and conditions apply.`;
            return text.trim();
        }

        function generateAndDownloadPDF() {
            const doc = new jsPDF();
            const data = quoteDataForActions;
            let y = 15;
            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("Official Insurance Quotation", 105, y, { align: "center" });
            y += 8;
            doc.setFontSize(10);
            doc.setFont("helvetica", "normal");
            doc.text(`Date: ${data.date}`, 105, y, { align: "center" });
            y += 15;

            doc.setFont("helvetica", "bold");
            doc.text("Client Information", 14, y);
            y += 7;
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${data.client.name}`, 14, y);
            doc.text(`Age: ${data.client.age || 'N/A'}`, 110, y);
            y += 7;
            doc.text(`Contact: ${data.client.contact}`, 14, y);
            doc.text(`Driving Exp: ${data.client.exp ? `${data.client.exp} years` : 'N/A'}`, 110, y);
            y += 12;

            doc.setFont("helvetica", "bold");
            doc.text("Vehicle Information", 14, y);
            y += 7;
            doc.setFont("helvetica", "normal");
            doc.text(`License Plate: ${data.vehicle.license || 'N/A'}`, 14, y);
            doc.text(`Vehicle Value: $${formatCurrency(data.vehicle.value)}`, 110, y);
            y += 7;
            doc.text(`Vehicle Age: ${data.vehicle.age ? `${data.vehicle.age} years` : 'N/A'}`, 14, y);
            y += 15;

            doc.setFont("helvetica", "bold");
            doc.text("Premium Breakdown", 14, y);
            doc.line(14, y + 2, 196, y + 2);
            y += 8;

            doc.setFont("courier", "normal");
            data.breakdown.forEach(row => {
                doc.text(row.label, 14, y);
                doc.text(row.value, 196, y, { align: 'right' });
                y += 6;
            });
            
            doc.setFontSize(8);
            doc.text("This quotation is valid for 30 days. Terms and conditions apply.", 105, 280, { align: 'center' });
            
            doc.save(`Insurance_Quote_${data.client.name.replace(/\s/g, '_')}.pdf`);
        }

        function copyQuoteToClipboard() {
            const textToCopy = getElement('quote-output').innerText;
            const btn = getElement('copy-quote-btn');
            if (navigator.clipboard) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    btn.textContent = 'Copied!';
                    setTimeout(() => { btn.textContent = 'Copy Details'; }, 2000);
                });
            } else { // Fallback for older browsers
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    btn.textContent = 'Copied!';
                } catch (err) {
                    btn.textContent = 'Failed!';
                }
                document.body.removeChild(textArea);
                setTimeout(() => { btn.textContent = 'Copy Details'; }, 2000);
            }
        }
        
        // --- HTML TEMPLATES ---
        function getCalculatorHTML() {
            // FIX: Removed the invalid escape character before the backtick
            return `
            <!-- Private Car Calculator -->
            <div id="private-calculator" class="form-section bento-box">
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-bold">Private Car Details</h2>
                     <label for="p-advanced-mode-check" class="flex items-center cursor-pointer"><span class="mr-3 text-sm font-medium">Advanced Mode</span><div class="relative"><input type="checkbox" id="p-advanced-mode-check" class="sr-only peer"><div class="block bg-gray-300 w-12 h-6 rounded-full peer-checked:bg-[var(--primary-accent)]"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition peer-checked:translate-x-6"></div></div></label>
                </div>
                 <div id="p-advanced-section" class="advanced-section">
                    <h4 class="font-semibold text-[var(--text-primary)] mb-2">Manual Rate Override</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label for="p-override-rate" class="block text-sm font-medium mb-1">Custom Rate (%)</label><input type="number" id="p-override-rate" class="w-full p-2" placeholder="e.g., 7.5"></div>
                        <fieldset class="space-y-1"><legend class="text-sm font-medium text-[var(--text-muted)] mb-1">Rate Includes:</legend><div class="flex items-center"><input type="checkbox" id="p-adv-inc-base" checked class="h-4 w-4"><label for="p-adv-inc-base" class="ml-2 text-sm">Base Premium</label></div><div class="flex items-center"><input type="checkbox" id="p-adv-inc-ncd" checked class="h-4 w-4"><label for="p-adv-inc-ncd" class="ml-2 text-sm">NCD</label></div><div class="flex items-center"><input type="checkbox" id="p-adv-inc-age-exp" class="h-4 w-4"><label for="p-adv-inc-age-exp" class="ml-2 text-sm">Age/Exp Loadings</label></div></fieldset>
                    </div>
                </div>
                <div class="space-y-6 mt-6">
                    <h3 class="text-lg font-bold text-[var(--text-secondary)]">Vehicle Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="p-sum-insured-container"><label for="p-sum-insured" class="block text-sm font-medium text-[var(--text-muted)]">Sum Insured ($)</label><input type="number" id="p-sum-insured" class="mt-1 w-full p-2.5" placeholder="e.g., 80000" min="50000"></div>
                        <div><label for="p-vehicle-age" class="block text-sm font-medium text-[var(--text-muted)]">Vehicle Age</label><input type="number" id="p-vehicle-age" class="mt-1 w-full p-2.5" placeholder="e.g., 5"></div>
                        <div><label for="p-coverage-type" class="block text-sm font-medium text-[var(--text-muted)]">Coverage</label><select id="p-coverage-type" class="mt-1 w-full p-2.5"><option value="comprehensive">Comprehensive</option><option value="third-party">Third Party</option></select></div>
                        <div><label for="p-engine-cc" class="block text-sm font-medium text-[var(--text-muted)]">Engine</label><select id="p-engine-cc" class="mt-1 w-full p-2.5"><option value="under-2000">Under 2000cc</option><option value="over-2000">Over 2000cc</option></select></div>
                        <div><label for="p-vehicle-model" class="block text-sm font-medium text-[var(--text-muted)]">Model Type</label><select id="p-vehicle-model" class="mt-1 w-full p-2.5"><option value="standard">Standard</option><option value="honda-city">Honda City</option><option value="hybrid">Hybrid</option><option value="electric">Electric</option></select></div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Driver Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                         <div><label for="p-driver-age" class="block text-sm font-medium text-[var(--text-muted)]">Driver's Age</label><input type="number" id="p-driver-age" class="mt-1 w-full p-2.5" placeholder="e.g., 35"></div>
                        <div><label for="p-driving-exp" class="block text-sm font-medium text-[var(--text-muted)]">Driving Exp.</label><input type="number" id="p-driving-exp" class="mt-1 w-full p-2.5" placeholder="e.g., 10"></div>
                         <div><label for="p-occupation" class="block text-sm font-medium text-[var(--text-muted)]">Occupation</label><select id="p-occupation" class="mt-1 w-full p-2.5"><option value="standard">Standard</option><option value="travelling">Travelling Officer</option><option value="music">Musician/DJ</option><option value="shift">Shift Worker</option><option value="protective">Protective Services</option></select></div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Extra Loadings</h3>
                    <div id="p-extra-loadings-container" class="space-y-2"></div>
                    <button id="p-add-loading-btn" class="mt-2 text-sm secondary-btn !py-1 !px-3 !normal-case">Add Loading</button>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Discounts</h3>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="p-ncd" class="block text-sm font-medium text-[var(--text-muted)]">No Claim Discount</label><select id="p-ncd" class="mt-1 w-full p-2.5"><option value="0">0 Years</option><option value="1">1 Year</option><option value="2">2 Years</option><option value="3">3 Years</option><option value="4">4+ Years (Max)</option></select></div>
                            <div class="grid grid-cols-1 gap-2"><div class="flex items-center"><input id="p-ansa-staff-check" type="checkbox" class="h-4 w-4"><label for="p-ansa-staff-check" class="ml-3 block text-sm font-medium">ANSA Staff (10%)</label></div><div class="flex items-center"><input id="p-other-motor-check" type="checkbox" class="h-4 w-4"><label for="p-other-motor-check" class="ml-3 block text-sm font-medium">Other Motor (10%)</label></div><div class="flex items-center"><input id="p-multi-client-check" type="checkbox" class="h-4 w-4"><label for="p-multi-client-check" class="ml-3 block text-sm font-medium">Multi-Client (15%)</label></div></div>
                        </div>
                        <h4 class="text-md font-bold text-[var(--text-secondary)] pt-2 border-t mt-4">Special Discounts</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="flex items-center"><input id="p-csr-check" type="checkbox" class="h-4 w-4"><label for="p-csr-check" class="ml-3 block text-sm font-medium">CSR/Agent</label><input type="number" id="p-csr-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="p-underwriter-check" type="checkbox" class="h-4 w-4"><label for="p-underwriter-check" class="ml-3 block text-sm font-medium">Underwriter</label><input type="number" id="p-underwriter-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="p-manager-check" type="checkbox" class="h-4 w-4"><label for="p-manager-check" class="ml-3 block text-sm font-medium">Manager Special</label><input type="number" id="p-manager-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="p-fleet-check" type="checkbox" class="h-4 w-4"><label for="p-fleet-check" class="ml-3 block text-sm font-medium">Fleet Discount</label><input type="number" id="p-fleet-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                        </div>
                    </div>
                     <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Optional Benefits</h3>
                    <div id="p-benefits-container" class="space-y-4">
                        <div class="flex items-center"><input id="p-windscreen-check" type="checkbox" class="h-4 w-4"><label for="p-windscreen-check" class="ml-3 block text-sm font-medium">Windscreen ($5k Free)</label><input type="number" id="p-windscreen-value" class="ml-4 w-40 p-1.5" placeholder="Total Value ($)" disabled></div>
                         <div id="p-woe-container" class="flex items-center"><input id="p-woe-check" type="checkbox" class="h-4 w-4"><label id="p-woe-label" for="p-woe-check" class="ml-3 block text-sm font-medium">Waiver of Excess</label></div>
                         <div id="p-lou-container" class="flex items-center"><input id="p-lou-check" type="checkbox" class="h-4 w-4"><label for="p-lou-check" class="ml-3 block text-sm font-medium">Loss of Use</label></div>
                        <div class="flex items-center"><input id="p-pa-check" type="checkbox" class="h-4 w-4"><label id="p-pa-label" for="p-pa-check" class="ml-3 block text-sm font-medium">Personal Accident</label></div>
                    </div>
                </div>
            </div>

            <!-- Platinum Drive Calculator -->
            <div id="platinum-calculator" class="form-section bento-box">
                 <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Platinum Drive Details</h2><label for="pl-advanced-mode-check" class="flex items-center cursor-pointer"><span class="mr-3 text-sm font-medium">Advanced Mode</span><div class="relative"><input type="checkbox" id="pl-advanced-mode-check" class="sr-only peer"><div class="block bg-gray-300 w-12 h-6 rounded-full peer-checked:bg-[var(--primary-accent)]"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition peer-checked:translate-x-6"></div></div></label></div>
                 <div id="pl-advanced-section" class="advanced-section"><h4 class="font-semibold text-[var(--text-primary)] mb-2">Manual Rate Override</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="pl-override-rate" class="block text-sm font-medium mb-1">Custom Rate (%)</label><input type="number" id="pl-override-rate" class="w-full p-2" placeholder="e.g., 3.5"></div><fieldset class="space-y-1"><legend class="text-sm font-medium text-[var(--text-muted)] mb-1">Rate Includes:</legend><div class="flex items-center"><input type="checkbox" id="pl-adv-inc-base" checked class="h-4 w-4"><label for="pl-adv-inc-base" class="ml-2 text-sm">Base Premium</label></div><div class="flex items-center"><input type="checkbox" id="pl-adv-inc-ncd" checked class="h-4 w-4"><label for="pl-adv-inc-ncd" class="ml-2 text-sm">NCD</label></div><div class="flex items-center"><input type="checkbox" id="pl-adv-inc-age-exp" class="h-4 w-4"><label for="pl-adv-inc-age-exp" class="ml-2 text-sm">Age/Exp Loadings</label></div></fieldset></div></div>
                <div class="space-y-6 mt-6">
                    <h3 class="text-lg font-bold text-[var(--text-secondary)]">Vehicle Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label for="pl-sum-insured" class="block text-sm font-medium text-[var(--text-muted)]">Sum Insured ($)</label><input type="number" id="pl-sum-insured" class="mt-1 w-full p-2.5" placeholder="Min $650,000" min="650000"></div>
                        <div><label for="pl-vehicle-age" class="block text-sm font-medium text-[var(--text-muted)]">Vehicle Age</label><input type="number" id="pl-vehicle-age" class="mt-1 w-full p-2.5" placeholder="Max 2" max="2"></div>
                        <div><label for="pl-engine-cc" class="block text-sm font-medium text-[var(--text-muted)]">Engine</label><select id="pl-engine-cc" class="mt-1 w-full p-2.5"><option value="under-2000">Under 2000cc</option><option value="over-2000">Over 2000cc</option></select></div>
                        <div><label for="pl-vehicle-model" class="block text-sm font-medium text-[var(--text-muted)]">Model Type</label><select id="pl-vehicle-model" class="mt-1 w-full p-2.5"><option value="standard">Standard</option><option value="hybrid">Hybrid</option><option value="electric">Electric</option></select></div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Driver Details</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                         <div><label for="pl-driver-age" class="block text-sm font-medium text-[var(--text-muted)]">Driver's Age</label><input type="number" id="pl-driver-age" class="mt-1 w-full p-2.5" placeholder="e.g., 35"></div>
                        <div><label for="pl-driving-exp" class="block text-sm font-medium text-[var(--text-muted)]">Driving Exp.</label><input type="number" id="pl-driving-exp" class="mt-1 w-full p-2.5" placeholder="e.g., 10"></div>
                         <div><label for="pl-occupation" class="block text-sm font-medium text-[var(--text-muted)]">Occupation</label><select id="pl-occupation" class="mt-1 w-full p-2.5"><option value="standard">Standard</option><option value="travelling">Travelling Officer</option><option value="music">Musician/DJ</option><option value="shift">Shift Worker</option><option value="protective">Protective Services</option></select></div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Extra Loadings</h3>
                    <div id="pl-extra-loadings-container" class="space-y-2"></div>
                    <button id="pl-add-loading-btn" class="mt-2 text-sm secondary-btn !py-1 !px-3 !normal-case">Add Loading</button>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Discounts</h3>
                     <p class="text-xs text-[var(--text-muted)] -mt-4">Note: Maximum NCD is required for Platinum Drive.</p>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="pl-ncd" class="block text-sm font-medium text-[var(--text-muted)]">No Claim Discount</label><select id="pl-ncd" class="mt-1 w-full p-2.5"><option value="4">4+ Years (Max)</option><option value="0">0 Years</option><option value="1">1 Year</option><option value="2">2 Years</option><option value="3">3 Years</option></select></div>
                            <div class="grid grid-cols-1 gap-2"><div class="flex items-center"><input id="pl-ansa-staff-check" type="checkbox" class="h-4 w-4"><label for="pl-ansa-staff-check" class="ml-3 block text-sm font-medium">ANSA Staff (10%)</label></div><div class="flex items-center"><input id="pl-other-motor-check" type="checkbox" class="h-4 w-4"><label for="pl-other-motor-check" class="ml-3 block text-sm font-medium">Other Motor (10%)</label></div><div class="flex items-center"><input id="pl-multi-client-check" type="checkbox" class="h-4 w-4"><label for="pl-multi-client-check" class="ml-3 block text-sm font-medium">Multi-Client (15%)</label></div></div>
                        </div>
                         <h4 class="text-md font-bold text-[var(--text-secondary)] pt-2 border-t mt-4">Special Discounts</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="flex items-center"><input id="pl-csr-check" type="checkbox" class="h-4 w-4"><label for="pl-csr-check" class="ml-3 block text-sm font-medium">CSR/Agent</label><input type="number" id="pl-csr-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="pl-underwriter-check" type="checkbox" class="h-4 w-4"><label for="pl-underwriter-check" class="ml-3 block text-sm font-medium">Underwriter</label><input type="number" id="pl-underwriter-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="pl-manager-check" type="checkbox" class="h-4 w-4"><label for="pl-manager-check" class="ml-3 block text-sm font-medium">Manager Special</label><input type="number" id="pl-manager-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="pl-fleet-check" type="checkbox" class="h-4 w-4"><label for="pl-fleet-check" class="ml-3 block text-sm font-medium">Fleet Discount</label><input type="number" id="pl-fleet-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Optional Benefits</h3>
                    <div class="space-y-4">
                         <p class="text-sm text-[var(--text-muted)] -mt-2">Loss of Use and Windscreen (up to $20,000) are included free.</p>
                        <div class="flex items-center"><input id="pl-windscreen-check" type="checkbox" class="h-4 w-4"><label for="pl-windscreen-check" class="ml-3 block text-sm font-medium">Increase Windscreen (>$20k)</label><input type="number" id="pl-windscreen-value" class="ml-4 w-40 p-1.5" placeholder="Total Value ($)" disabled></div>
                         <div id="pl-woe-container" class="flex items-center"><input id="pl-woe-check" type="checkbox" class="h-4 w-4"><label id="pl-woe-label" for="pl-woe-check" class="ml-3 block text-sm font-medium">Waiver of Excess</label></div>
                         <div class="flex items-center"><input id="pl-pa-check" type="checkbox" class="h-4 w-4"><label for="pl-pa-check" class="ml-3 block text-sm font-medium">Personal Accident ($200k)</label></div>
                         <div class="flex items-center"><input id="pl-tpl-check" type="checkbox" class="h-4 w-4"><label for="pl-tpl-check" class="ml-3 block text-sm font-medium">Increased Third Party Limits</label></div>
                    </div>
                </div>
            </div>
            
            <!-- Commercial Vehicle Calculator -->
            <div id="commercial-calculator" class="form-section bento-box">
                <div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold">Commercial Details</h2><label for="c-advanced-mode-check" class="flex items-center cursor-pointer"><span class="mr-3 text-sm font-medium">Advanced Mode</span><div class="relative"><input type="checkbox" id="c-advanced-mode-check" class="sr-only peer"><div class="block bg-gray-300 w-12 h-6 rounded-full peer-checked:bg-[var(--primary-accent)]"></div><div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition peer-checked:translate-x-6"></div></div></label></div>
                 <div id="c-advanced-section" class="advanced-section"><h4 class="font-semibold text-[var(--text-primary)] mb-2">Manual Rate Override</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="c-override-rate" class="block text-sm font-medium mb-1">Custom Rate (%)</label><input type="number" id="c-override-rate" class="w-full p-2" placeholder="e.g., 8.5"></div><fieldset class="space-y-1"><legend class="text-sm font-medium text-[var(--text-muted)] mb-1">Rate Includes:</legend><div class="flex items-center"><input type="checkbox" id="c-adv-inc-base" checked class="h-4 w-4"><label for="c-adv-inc-base" class="ml-2 text-sm">Base Premium</label></div><div class="flex items-center"><input type="checkbox" id="c-adv-inc-ncd" checked class="h-4 w-4"><label for="c-adv-inc-ncd" class="ml-2 text-sm">NCD</label></div><div class="flex items-center"><input type="checkbox" id="c-adv-inc-age-exp" class="h-4 w-4"><label for="c-adv-inc-age-exp" class="ml-2 text-sm">Age/Exp Loadings</label></div></fieldset></div></div>
                 <div class="space-y-6 mt-6">
                    <h3 class="text-lg font-bold text-[var(--text-secondary)]">Vehicle Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div id="c-sum-insured-container"><label for="c-sum-insured" class="block text-sm font-medium text-[var(--text-muted)]">Sum Insured ($)</label><input type="number" id="c-sum-insured" class="mt-1 w-full p-2.5" placeholder="e.g., 90000" min="50000"></div>
                        <div><label for="c-vehicle-age" class="block text-sm font-medium text-[var(--text-muted)]">Vehicle Age</label><input type="number" id="c-vehicle-age" class="mt-1 w-full p-2.5" placeholder="e.g., 5"></div>
                        <div><label for="c-coverage-type" class="block text-sm font-medium text-[var(--text-muted)]">Coverage</label><select id="c-coverage-type" class="mt-1 w-full p-2.5"><option value="comprehensive">Comprehensive</option><option value="third-party">Third Party</option></select></div>
                        <div id="c-usage-container"><label for="c-usage" class="block text-sm font-medium text-[var(--text-muted)]">Usage</label><select id="c-usage" class="mt-1 w-full p-2.5"><option value="private-pickup">Private Use Pick-up</option><option value="own-goods">Own Goods</option><option value="other">All Other Usages</option></select></div>
                        <div id="c-hp-container" class="hidden"><label for="c-hp" class="block text-sm font-medium text-[var(--text-muted)]">Horsepower (HP)</label><select id="c-hp" class="mt-1 w-full p-2.5"><option value="upto-30">Up to 30 HP</option><option value="31-50">31 - 50 HP</option><option value="over-50">Over 50 HP</option></select></div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Driver Details</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><label for="c-driver-age" class="block text-sm font-medium text-[var(--text-muted)]">Driver's Age</label><input type="number" id="c-driver-age" class="mt-1 w-full p-2.5" placeholder="e.g., 35"></div>
                        <div><label for="c-driving-exp" class="block text-sm font-medium text-[var(--text-muted)]">Driving Exp.</label><input type="number" id="c-driving-exp" class="mt-1 w-full p-2.5" placeholder="e.g., 10"></div>
                        <div><label for="c-occupation" class="block text-sm font-medium text-[var(--text-muted)]">Occupation</label><select id="c-occupation" class="mt-1 w-full p-2.5"><option value="standard">Standard</option><option value="travelling">Travelling Officer</option><option value="music">Musician/DJ</option><option value="shift">Shift Worker</option><option value="protective">Protective Services</option></select></div>
                    </div>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Extra Loadings</h3>
                    <div id="c-extra-loadings-container" class="space-y-2"></div>
                    <button id="c-add-loading-btn" class="mt-2 text-sm secondary-btn !py-1 !px-3 !normal-case">Add Loading</button>
                    <h3 class="text-lg font-bold text-[var(--text-secondary)] border-t pt-6 mt-6">Discounts</h3>
                    <div id="c-discounts-section" class="space-y-4">
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div><label for="c-ncd" class="block text-sm font-medium text-[var(--text-muted)]">No Claim Discount</label><select id="c-ncd" class="mt-1 w-full p-2.5"><option value="0">0 Years</option><option value="1">1 Year</option><option value="2">2 Years</option><option value="3">3 Years</option><option value="4">4+ Years (Max)</option></select></div>
                            <div class="grid grid-cols-1 gap-2"><div class="flex items-center"><input id="c-ansa-staff-check" type="checkbox" class="h-4 w-4"><label for="c-ansa-staff-check" class="ml-3 block text-sm font-medium">ANSA Staff (10%)</label></div><div class="flex items-center"><input id="c-other-motor-check" type="checkbox" class="h-4 w-4"><label for="c-other-motor-check" class="ml-3 block text-sm font-medium">Other Motor (10%)</label></div><div class="flex items-center"><input id="c-multi-client-check" type="checkbox" class="h-4 w-4"><label for="c-multi-client-check" class="ml-3 block text-sm font-medium">Multi-Client (15%)</label></div></div>
                        </div>
                        <div id="c-private-pickup-discount-container" class="hidden"><label for="c-private-pickup-discount" class="block text-sm font-medium text-[var(--text-muted)]">Private Use Pick-Up Discount</label><select id="c-private-pickup-discount" class="mt-1 w-full p-2.5"><option value="0">None</option><option value="0.10">10%</option><option value="0.15">15%</option><option value="0.20">20%</option><option value="0.25">25%</option></select></div>
                         <h4 class="text-md font-bold text-[var(--text-secondary)] pt-2 border-t mt-4">Special Discounts</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                            <div class="flex items-center"><input id="c-csr-check" type="checkbox" class="h-4 w-4"><label for="c-csr-check" class="ml-3 block text-sm font-medium">CSR/Agent</label><input type="number" id="c-csr-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="c-underwriter-check" type="checkbox" class="h-4 w-4"><label for="c-underwriter-check" class="ml-3 block text-sm font-medium">Underwriter</label><input type="number" id="c-underwriter-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="c-manager-check" type="checkbox" class="h-4 w-4"><label for="c-manager-check" class="ml-3 block text-sm font-medium">Manager Special</label><input type="number" id="c-manager-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                            <div class="flex items-center"><input id="c-fleet-check" type="checkbox" class="h-4 w-4"><label for="c-fleet-check" class="ml-3 block text-sm font-medium">Fleet Discount</label><input type="number" id="c-fleet-value" class="ml-auto w-24 p-1.5" placeholder="%" disabled></div>
                        </div>
                    </div>
                 </div>
            </div>
            `;
        }

    </script>
</body>
</html>
