<!DOCTYPE html>
<html lang="en-TT" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Insurance Referral Hub</title>
    <meta name="description"
        content="A platform for insurance referrers to create quotes and track commissions for motor and health insurance.">
    <meta name="author" content="Your Name">

    <!-- PWA Manifest & Meta Tags -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#005f73">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Referral Hub">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/005f73/FFFFFF?text=Hub">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        :root {
            --bg-main: #f4f6f9;
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35;
            --text-secondary: #4a5568;
            --border-color: #dce1e7;
            --primary-accent: #005f73;
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625;
            --shadow-soft: 0 3px 6px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.06);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif;
        }

        .dark-mode {
            --bg-main: #1f2937;
            --bg-bento-box: #2b3c4d;
            --text-primary: #f0f4f8;
            --text-secondary: #d1d5db;
            --border-color: #4b5f71;
            --primary-accent: #25a1af;
            --primary-accent-darker: #1e838f;
            --secondary-accent: #daa520;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .page-title {
            font-family: var(--font-heading);
            color: var(--primary-accent);
            font-weight: 700;
        }
        
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem;
            padding: 1.75rem;
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .bento-box:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-strong);
        }

        .button-base {
            display: inline-block;
            font-weight: 600;
            padding: 0.85rem 1.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-soft);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
        }
        
        .button-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }

        .button-base:hover {
            transform: translateY(-2px);
        }

        .main-action-button {
            background-color: var(--primary-accent);
            color: white;
        }

        .dark-mode .main-action-button {
            color: var(--text-primary);
        }

        .main-action-button:hover {
            background-color: var(--primary-accent-darker);
        }
        
        input, select {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main); color: var(--text-primary);
            font-weight: 500;
        }
        input:focus, select:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(29, 45, 53, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-bento-box); margin: auto; padding: 2rem; border: 1px solid var(--border-color);
            width: 90%; max-width: 640px; 
            border-radius: 0.75rem; position: relative;
            box-shadow: var(--shadow-strong);
        }
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-muted);
        }
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--primary-accent);
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .tier-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
        }
        .tier-Bronze { background-color: #CD7F32; color: white; }
        .tier-Silver { background-color: #C0C0C0; color: var(--text-primary); }
        .tier-Gold { background-color: #FFD700; color: var(--text-primary); }
    </style>
</head>

<body class="min-h-screen">
    <div id="app-container" class="w-full max-w-7xl mx-auto my-8 p-4 md:p-6 lg:p-8">
        <!-- Auth Loader -->
        <div id="auth-loader" class="flex items-center justify-center py-20">
            <div class="text-center">
                <div class="loader mx-auto"></div>
                <p class="mt-4 text-[var(--text-secondary)]">Authenticating...</p>
            </div>
        </div>

        <!-- Login/Register View -->
        <div id="auth-view" class="hidden">
            <header class="mb-10 md:mb-14 text-center">
                <h1 class="page-title text-4xl sm:text-5xl md:text-6xl mb-2">
                    Insurance Referral Hub
                </h1>
                <p class="text-xl font-semibold text-[var(--secondary-accent)] mb-4">Earn money for your referrals!</p>
                <p class="text-[var(--text-secondary)] text-md md:text-lg max-w-3xl mx-auto">
                    Welcome! Please sign in or register to continue.
                </p>
            </header>
            <main class="max-w-md mx-auto">
                <div class="bento-box">
                    <div id="auth-form-container">
                        <!-- Login Form -->
                        <form id="login-form" class="space-y-6">
                            <h2 class="text-2xl font-bold text-center text-[var(--primary-accent)]">Sign In</h2>
                            <div>
                                <label for="login-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label>
                                <input type="email" id="login-email" required class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="login-password"
                                    class="block text-sm font-medium text-[var(--text-muted)]">Password</label>
                                <div class="relative">
                                    <input type="password" id="login-password" required class="mt-1 w-full pr-10">
                                    <i class="fas fa-eye password-toggle" id="toggle-login-password"></i>
                                </div>
                                <a href="#" id="forgot-password-link" class="text-xs text-[var(--primary-accent)] hover:underline mt-1 block text-right">Forgot Password?</a>
                            </div>
                            <p id="login-error" class="text-red-500 text-sm text-center h-4"></p>
                            <button type="submit" class="w-full main-action-button button-base">Sign In</button>
                            <p class="text-center text-sm">
                                Don't have an account? <a href="#" id="show-register" class="font-semibold text-[var(--primary-accent)] hover:underline">Register here</a>
                            </p>
                        </form>

                        <!-- Register Form (hidden by default) -->
                        <form id="register-form" class="hidden space-y-6">
                             <h2 class="text-2xl font-bold text-center text-[var(--primary-accent)]">Register</h2>
                            <div>
                                <label for="register-name" class="block text-sm font-medium text-[var(--text-muted)]">Full Name</label>
                                <input type="text" id="register-name" required class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="register-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label>
                                <input type="email" id="register-email" required class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="register-password"
                                    class="block text-sm font-medium text-[var(--text-muted)]">Password</label>
                                <div class="relative">
                                    <input type="password" id="register-password" required class="mt-1 w-full pr-10">
                                    <i class="fas fa-eye password-toggle" id="toggle-register-password"></i>
                                </div>
                            </div>
                            <p id="register-error" class="text-red-500 text-sm text-center h-4"></p>
                            <button type="submit" class="w-full main-action-button button-base">Register</button>
                             <p class="text-center text-sm">
                                Already have an account? <a href="#" id="show-login" class="font-semibold text-[var(--primary-accent)] hover:underline">Sign in here</a>
                            </p>
                        </form>
                    </div>
                </div>
            </main>
        </div>

        <!-- Main App View (Dashboard) -->
        <div id="app-view" class="hidden">
             <header class="flex flex-wrap justify-between items-center mb-10 md:mb-14 gap-4">
                <div>
                    <h1 id="dashboard-title" class="page-title text-3xl sm:text-4xl md:text-5xl">
                        Referrer Dashboard
                    </h1>
                    <p id="user-greeting" class="text-[var(--text-secondary)] text-lg"></p>
                </div>
                <div id="nav-buttons" class="flex items-center space-x-4">
                    <div id="admin-link-container"></div>
                    <a href="./profile.html" class="button-base bg-white text-[var(--primary-accent)] text-sm py-2 px-4 !px-4 !py-2">My Profile</a>
                    <button id="logout-btn" class="button-base bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-4 !px-4 !py-2">Logout</button>
                </div>
            </header>

            <main class="space-y-12">
                <section class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bento-box">
                         <h2 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Your Level</h2>
                         <div id="tier-progress-container">
                             <!-- Gamification UI will be injected here -->
                         </div>
                    </div>
                    <div class="bento-box">
                         <h2 class="text-2xl font-bold text-center text-[var(--primary-accent)] mb-4">This Month's Performance</h2>
                         <div class="relative h-48 w-48 mx-auto">
                            <canvas id="performanceChart"></canvas>
                         </div>
                    </div>
                </section>
                
                <section>
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-8 text-[var(--primary-accent)]">Create a New Referral</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bento-box text-center">
                            <i class="fas fa-car-side text-5xl text-[var(--primary-accent)] mx-auto mb-4"></i>
                            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Motor Insurance</h3>
                            <p class="text-[var(--text-secondary)] text-sm mb-6 flex-grow">
                                Get a premium estimate for a private or commercial vehicle.
                            </p>
                            <a href="./motor_rater.html" class="main-action-button button-base mt-4">Open Motor Rater</a>
                        </div>
                        <div class="bento-box text-center">
                            <i class="fas fa-heart-pulse text-5xl text-[var(--primary-accent)] mx-auto mb-4"></i>
                            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Health Insurance</h3>
                            <p class="text-[var(--text-secondary)] text-sm mb-6 flex-grow">
                               Calculate premiums for individual or family health plans.
                            </p>
                            <a href="./health_rater.html" class="main-action-button button-base mt-4">Open Health Rater</a>
                        </div>
                         <div class="bento-box text-center">
                            <i class="fas fa-home text-5xl text-[var(--primary-accent)] mx-auto mb-4"></i>
                            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Property Insurance</h3>
                            <p class="text-[var(--text-secondary)] text-sm mb-6 flex-grow">
                               Quote Homeowners and Commercial Property policies.
                            </p>
                            <a href="./property_rater.html" class="main-action-button button-base mt-4">Open Property Rater</a>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[var(--primary-accent)]">My Referrals</h2>
                    <div class="bento-box overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="whitespace-nowrap">
                                <tr class="border-b border-[var(--border-color)]">
                                    <th class="p-4 text-sm font-semibold">Date</th>
                                    <th class="p-4 text-sm font-semibold">Client</th>
                                    <th class="p-4 text-sm font-semibold text-right">Approved Premium</th>
                                    <th class="p-4 text-sm font-semibold text-right">Your Finder's Fee</th>
                                    <th class="p-4 text-sm font-semibold text-center">Status</th>
                                    <th class="p-4 text-sm font-semibold text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="referrals-table-body"></tbody>
                        </table>
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[var(--primary-accent)]">Payment History</h2>
                    <div class="bento-box overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="whitespace-nowrap">
                                <tr class="border-b border-[var(--border-color)]">
                                    <th class="p-4 text-sm font-semibold">Payout Date</th>
                                    <th class="p-4 text-sm font-semibold">Period Covered</th>
                                    <th class="p-4 text-sm font-semibold text-right">Total Paid</th>
                                </tr>
                            </thead>
                            <tbody id="payment-history-table-body"></tbody>
                        </table>
                    </div>
                </section>

                 <footer class="text-center mt-12 text-xs text-[var(--text-muted)]">
                    <p>&copy; <span id="currentYear"></span> Your Company Name. All Rights Reserved.</p>
                </footer>
            </main>
        </div>
    </div>
    
    <!-- Referral Details Modal -->
    <div id="details-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-2xl font-bold text-[var(--primary-accent)]">Referral Details</h3>
                <button id="close-details-modal-btn" class="text-2xl text-[var(--text-muted)] hover:text-[var(--primary-accent)]">&times;</button>
            </div>
            <div id="details-modal-content" class="text-sm space-y-2 text-[var(--text-secondary)] max-h-[60vh] overflow-y-auto pr-2">
                <!-- Details will be injected here -->
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="reset-password-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-md">
            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Reset Password</h3>
            <form id="reset-password-form">
                <p class="text-[var(--text-secondary)] text-sm mb-4">Enter your email address and we'll send you a link to reset your password.</p>
                <div>
                    <label for="reset-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label>
                    <input type="email" id="reset-email" required class="mt-1 w-full">
                </div>
                <p id="reset-message" class="text-sm text-center h-4 my-4"></p>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="close-reset-modal-btn" class="button-base bg-gray-200 text-gray-700">Cancel</button>
                    <button type="submit" class="button-base main-action-button">Send Reset Link</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- NEW: Forced Password Reset Modal -->
    <div id="force-reset-modal" class="modal-overlay hidden">
        <div class="modal-content max-w-lg text-center">
            <i class="fas fa-shield-halved text-5xl text-yellow-500 mx-auto mb-4"></i>
            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Security Update Required</h3>
            <p class="text-[var(--text-secondary)] text-sm mb-6">For your security, we require passwords to be updated every 90 days. Your password has expired.</p>
            <p id="force-reset-message" class="text-sm h-4 my-4"></p>
            <div class="flex justify-center gap-3 pt-4">
                <button type="button" id="force-reset-send-link-btn" class="button-base primary-btn">Send Password Reset Link</button>
                <button type="button" id="force-reset-logout-btn" class="button-base bg-red-600 text-white">Logout</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            sendPasswordResetEmail,
            onAuthStateChanged,
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            setDoc,
            collection,
            query,
            where,
            onSnapshot,
            updateDoc,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let userReferrals = [];
        let performanceChart = null;
        
        let commissionTiers = [];
        let currentUserData = null;


        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                 logoutBtn.addEventListener('click', () => {
                    signOut(auth).then(() => {
                        window.location.reload();
                    }).catch(error => console.error('Logout error:', error));
                });
            }

            onAuthStateChanged(auth, async (user) => {
                const authLoader = document.getElementById('auth-loader');
                const authView = document.getElementById('auth-view');
                const appView = document.getElementById('app-view');

                if (user) {
                    const passwordPolicyMet = await checkPasswordPolicy(user);
                    if (passwordPolicyMet) {
                        authLoader.classList.add('hidden');
                        authView.classList.add('hidden');
                        appView.classList.remove('hidden');
                        await setupDashboard(user);
                    } else {
                        authLoader.classList.add('hidden');
                        authView.classList.add('hidden');
                        appView.classList.add('hidden');
                        document.getElementById('force-reset-modal').classList.remove('hidden');
                    }
                } else {
                    currentUserData = null;
                    commissionTiers = [];
                    authLoader.classList.add('hidden');
                    appView.classList.add('hidden');
                    authView.classList.remove('hidden');
                    if(document.getElementById('admin-link-container')) {
                         document.getElementById('admin-link-container').innerHTML = '';
                    }
                }
            });
            
            const referralsTableBody = document.getElementById('referrals-table-body');
            if(referralsTableBody) {
                referralsTableBody.addEventListener('click', e => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const referralId = target.dataset.id;

                    if (target.classList.contains('view-details-btn')) {
                        const referral = userReferrals.find(r => r.id === referralId);
                        if (referral) showDetailsModal(referral);
                    }
                    if (target.classList.contains('edit-referral-btn')) {
                        const insuranceType = target.dataset.type.toLowerCase();
                        window.location.href = `./${insuranceType}_rater.html?edit=${referralId}`;
                    }
                    if (target.classList.contains('update-status-btn')) {
                        const newStatus = target.dataset.status;
                        if (confirm(`Are you sure you want to mark this referral as "${newStatus}"?`)) {
                            updateReferralStatus(referralId, newStatus);
                        }
                    }
                });
            }
             document.getElementById('close-details-modal-btn').addEventListener('click', () => {
                document.getElementById('details-modal').classList.add('hidden');
            });
            setupAuthForms();
        });
        
        async function checkPasswordPolicy(user) {
            const userDocRef = doc(db, 'users', user.uid);
            const userDoc = await getDoc(userDocRef);

            if (!userDoc.exists()) return true;

            const userData = userDoc.data();
            const lastUpdate = userData.passwordLastUpdatedAt?.toDate();
            
            if (!lastUpdate) {
                await updateDoc(userDocRef, { passwordLastUpdatedAt: Timestamp.now() });
                return true;
            }

            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);

            return lastUpdate >= ninetyDaysAgo;
        }


        async function setupDashboard(user) {
            document.getElementById('user-greeting').textContent = `Hello, ${user.displayName || user.email}!`;
            
            const settingsRef = doc(db, "settings", "commissionTiers");
            
            onSnapshot(settingsRef, (settingsDoc) => {
                if (settingsDoc.exists()) {
                    commissionTiers = settingsDoc.data().tiers;
                    if (currentUserData) {
                        displayTierProgress(currentUserData);
                    }
                } else {
                    console.error("Commission Tiers settings not found in Firestore!");
                    const container = document.getElementById('tier-progress-container');
                    if(container) container.innerHTML = `<p class="text-red-500">Error: Commission tier settings could not be loaded.</p>`;
                }
            });

            onSnapshot(doc(db, "users", user.uid), (userDoc) => {
                if (userDoc.exists()) {
                    currentUserData = userDoc.data(); 
                    
                    const adminLinkContainer = document.getElementById('admin-link-container');
                    const dashboardTitle = document.getElementById('dashboard-title');
                    if (currentUserData.role === 'admin') {
                       if(dashboardTitle) dashboardTitle.textContent = "Admin / Referrer Dashboard";
                       if(adminLinkContainer) adminLinkContainer.innerHTML = `<a href="./admin.html" class="button-base !px-4 !py-2 bg-[var(--secondary-accent)] text-white">Admin Panel</a>`;
                    } else {
                        if(adminLinkContainer) adminLinkContainer.innerHTML = '';
                        if(dashboardTitle) dashboardTitle.textContent = "Referrer Dashboard";
                    }
                    
                    if (commissionTiers.length > 0) {
                        displayTierProgress(currentUserData);
                    } else {
                        const container = document.getElementById('tier-progress-container');
                        if (container) container.innerHTML = `<p class="text-sm text-[var(--text-muted)]">Loading tier progress...</p>`;
                    }
                }
            });
            
            loadDashboardData(user.uid);
        }

        function loadDashboardData(userId) {
            const referralsQuery = query(collection(db, "referrals"), where("referrerId", "==", userId));
            onSnapshot(referralsQuery, (snapshot) => {
                userReferrals = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                userReferrals.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
                displayReferrals(userReferrals);
                updateUnpaidBalance(userReferrals);
                updatePerformanceChart(userReferrals);
            }, (error) => {
                console.error("Error loading referrals:", error);
                document.getElementById('referrals-table-body').innerHTML = `<tr><td colspan="6" class="text-center p-8 text-red-500">Could not load referrals due to a database error.</td></tr>`;
            });
            
            // --- FIX START: Corrected query for payment history ---
            try {
                // This query is now secure because it only looks inside the logged-in user's own data.
                // NOTE: This requires the 'processMonthlyPayouts' cloud function to be updated
                // to write payment records to '/users/{userId}/paymentHistory/{paymentId}'.
                const paymentsQuery = query(collection(db, "users", userId, "paymentHistory"));
                onSnapshot(paymentsQuery, (snapshot) => {
                    const userPayments = snapshot.docs.map(p => {
                        const paymentData = p.data();
                        // Data structure is now simpler as it's directly from the user's subcollection.
                        return {
                            id: p.id,
                            payoutDate: paymentData.payoutDate,
                            periodCovered: paymentData.periodCovered,
                            totalPaid: paymentData.totalPaid || 0,
                        };
                    });
                    displayPaymentHistory(userPayments); // Display the filtered list
                }, (error) => {
                     console.error("Could not load payment history:", error.message);
                     const paymentHistoryTableBody = document.getElementById('payment-history-table-body');
                     if(paymentHistoryTableBody) paymentHistoryTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-[var(--text-muted)]">Could not load payment history.</td></tr>`;
                });
            } catch (error) {
                 console.error("Error setting up payment listener:", error);
                 const paymentHistoryTableBody = document.getElementById('payment-history-table-body');
                 if(paymentHistoryTableBody) paymentHistoryTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-[var(--text-muted)]">Error loading payment history.</td></tr>`;
            }
            // --- FIX END ---
        }
        
        function displayTierProgress(userData) {
            const container = document.getElementById('tier-progress-container');
            if (!container || !userData || !commissionTiers || commissionTiers.length === 0) {
                if (container) container.innerHTML = `<p class="text-sm text-[var(--text-muted)]">Loading tier progress...</p>`;
                return;
            }
            
            const currentTierName = userData.currentTier || 'Bronze';
            const wonCount = userData.wonReferralsCount || 0;
            
            const currentTier = commissionTiers.find(t => t.name === currentTierName) || commissionTiers[0];
            const currentTierIndex = commissionTiers.findIndex(t => t.name === currentTierName);
            const nextTier = (currentTierIndex >= 0 && currentTierIndex + 1 < commissionTiers.length) ? commissionTiers[currentTierIndex + 1] : null;

            let progressHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Your Level: <span class="tier-badge tier-${currentTierName}">${currentTierName}</span></h3>
                    <p class="text-lg font-semibold text-[var(--primary-accent)]">${currentTier.split}% Split</p>
                </div>
            `;
            
            if (nextTier) {
                const referralsNeeded = nextTier.minReferrals - wonCount;
                const progressPercent = Math.min(100, (wonCount / nextTier.minReferrals) * 100);
                progressHTML += `
                    <p class="text-sm text-[var(--text-secondary)] mb-2">You are <strong>${referralsNeeded > 0 ? referralsNeeded : 0}</strong> won ${referralsNeeded === 1 ? 'referral' : 'referrals'} away from the <strong>${nextTier.name}</strong> tier!</p>
                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                        <div class="bg-[var(--secondary-accent)] h-4 rounded-full transition-all duration-500" style="width: ${progressPercent}%"></div>
                    </div>
                     <p class="text-xs text-right mt-1">${wonCount} / ${nextTier.minReferrals}</p>
                `;
            } else {
                 progressHTML += `<p class="font-bold text-green-500 mt-2"><i class="fas fa-crown mr-2"></i>You have reached the highest tier! Congratulations!</p>`;
            }
            
            progressHTML += `<div class="mt-6 pt-4 border-t border-[var(--border-color)] text-sm space-y-2">`;
            commissionTiers.forEach(tier => {
                 progressHTML += `
                    <div class="flex justify-between items-center">
                        <span class="font-bold tier-badge tier-${tier.name}">${tier.name}</span>
                        <span>Requires: <strong>${tier.minReferrals}</strong> won | Split: <strong>${tier.split}%</strong> | Bonus: <strong>${tier.bonusPercentage || 0}%</strong></span>
                    </div>
                 `;
            });
            progressHTML += `</div>`;


            container.innerHTML = progressHTML;
        }
        
        function updateUnpaidBalance(referrals) {
            const unpaidFindersFeeTotal = document.getElementById('unpaid-finders-fee-total');
            if (!unpaidFindersFeeTotal) return;
            const unpaidTotal = referrals
                .filter(r => r.status === 'Won' && !r.feeWaived)
                .reduce((total, r) => total + (r.finalFindersFee || r.findersFee), 0);
            unpaidFindersFeeTotal.textContent = formatCurrency(unpaidTotal);
        }

        function displayReferrals(referrals) {
            const referralsTableBody = document.getElementById('referrals-table-body');
            if (!referralsTableBody) return;
            if (!referrals.length) {
                referralsTableBody.innerHTML = '<tr><td colspan="6" class="text-center p-8 text-[var(--text-muted)]">You have not made any referrals yet.</td></tr>';
                return;
            }
            referralsTableBody.innerHTML = referrals.map(referral => {
                const statusClass = getStatusClass(referral.status);
                const finalFee = referral.feeWaived ? 0 : (referral.finalFindersFee || referral.findersFee);
                const canEdit = ['Pending', 'Approved', 'Resubmitted'].includes(referral.status);

                return `
                    <tr class="border-b border-[var(--border-color)] hover:bg-[var(--bg-main)] ${referral.status === 'Paid' ? 'opacity-50' : ''}">
                        <td class="p-4">${referral.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="p-4">${referral.clientName}</td>
                        <td class="p-4 text-right">${referral.approvedPremium ? formatCurrency(referral.approvedPremium) : 'N/A'}</td>
                        <td class="p-4 text-right text-green-600 font-semibold">${formatCurrency(finalFee)}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                ${referral.status}
                            </span>
                        </td>
                        <td class="p-4 text-center space-x-2">
                            <button class="button-base button-sm bg-[var(--secondary-accent)] text-white view-details-btn" data-id="${referral.id}">Details</button>
                            ${canEdit ? `
                                <button class="button-base button-sm bg-blue-600 text-white edit-referral-btn" data-id="${referral.id}" data-type="${referral.insuranceType}">Edit</button>
                                <button class="button-base button-sm bg-red-500 text-white update-status-btn" data-id="${referral.id}" data-status="Lost">Lost</button>
                                <button class="button-base button-sm bg-yellow-500 text-white update-status-btn" data-id="${referral.id}" data-status="Cancelled">Cancel</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function displayPaymentHistory(payments) {
            const paymentHistoryTableBody = document.getElementById('payment-history-table-body');
            if (!paymentHistoryTableBody) return;

            payments.sort((a, b) => b.payoutDate.toDate() - a.payoutDate.toDate());
            
            if(!payments.length) {
                paymentHistoryTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-[var(--text-muted)]">No payment history found.</td></tr>`;
                return;
            }
             paymentHistoryTableBody.innerHTML = payments.map(p => `
                <tr class="border-b border-[var(--border-color)]">
                    <td class="p-4">${p.payoutDate.toDate().toLocaleDateString()}</td>
                    <td class="p-4">${p.periodCovered}</td>
                    <td class="p-4 text-right font-semibold">${formatCurrency(p.totalPaid)}</td>
                </tr>
            `).join('');
        }

        async function updateReferralStatus(id, status) {
            const referralRef = doc(db, "referrals", id);
            try {
                await updateDoc(referralRef, { 
                    status: status,
                    lastUpdatedAt: Timestamp.now()
                });
            } catch (error) {
                console.error("Error updating status: ", error);
                alert("Could not update the referral's status. Please try again.");
            }
        }

        function showDetailsModal(referral) {
            const contentEl = document.getElementById('details-modal-content');
            let contentHTML = '';
            const excludedKeys = ['id', 'referrerId', 'referrerName'];

            for (const [key, value] of Object.entries(referral)) {
                if (excludedKeys.includes(key)) continue;

                let displayValue = value;
                if (value instanceof Timestamp) {
                    displayValue = value.toDate().toLocaleString();
                } else if (typeof value === 'object' && value !== null) {
                    displayValue = `<pre class="bg-[var(--bg-main)] p-2 rounded-md mt-1">${JSON.stringify(value, null, 2)}</pre>`;
                } else if (typeof value === 'number' && (key.toLowerCase().includes('premium') || key.toLowerCase().includes('fee'))) {
                    displayValue = formatCurrency(value);
                } else if (key === 'feeWaived' && typeof value === 'boolean') {
                    displayValue = value ? 'Yes' : 'No';
                }

                contentHTML += `<div class="grid grid-cols-3 gap-4 border-b border-[var(--border-color)] py-2">
                                  <strong class="col-span-1 capitalize">${key.replace(/([A-Z])/g, ' $1').trim()}:</strong>
                                  <span class="col-span-2">${displayValue}</span>
                                </div>`;
            }

            contentEl.innerHTML = contentHTML;
            document.getElementById('details-modal').classList.remove('hidden');
        }


        function getStatusClass(status) {
            switch(status) {
                case 'Pending': return 'bg-yellow-100 text-yellow-800';
                case 'Approved': return 'bg-blue-100 text-blue-800';
                case 'Won': return 'bg-green-100 text-green-800';
                case 'Lost': case 'Rejected': case 'Cancelled': return 'bg-red-100 text-red-800';
                case 'Paid': return 'bg-gray-400 text-white';
                case 'Resubmitted': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '$0.00';
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
        
        function updatePerformanceChart(referrals) {
            const chartEl = document.getElementById('performanceChart');
            if (!chartEl) return;
            const ctx = chartEl.getContext('2d');
            
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const submittedThisMonth = referrals.filter(r => {
                const createdAt = r.createdAt.toDate();
                return createdAt >= startOfMonth;
            });

            const potentialFees = submittedThisMonth
                .filter(r => !r.feeWaived)
                .reduce((sum, r) => sum + (r.findersFee || 0), 0);

            const wonFees = submittedThisMonth
                .filter(r => (r.status === 'Won' || r.status === 'Paid') && !r.feeWaived)
                .reduce((sum, r) => sum + (r.finalFindersFee || r.findersFee || 0), 0);
            
            const pendingOrLostFees = Math.max(0, potentialFees - wonFees);

            const data = {
                labels: ['Won Fees From This Month\'s Submissions', 'Other Fees From This Month\'s Submissions'],
                datasets: [{
                    data: [wonFees, pendingOrLostFees],
                    backgroundColor: ['#16a34a', '#d1d5db'],
                    borderColor: 'var(--bg-bento-box)',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            };

            if (performanceChart) {
                performanceChart.data = data;
                performanceChart.update();
            } else {
                performanceChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '70%',
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (context) => formatCurrency(context.parsed)
                                }
                            }
                        }
                    }
                });
            }
        }
        
        function setupAuthForms() {
            document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); });
            document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
            
            document.getElementById('login-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const email = document.getElementById('login-email').value; 
                const password = document.getElementById('login-password').value; 
                const errorEl = document.getElementById('login-error');
                errorEl.textContent = '';
                try { 
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const userDocRef = doc(db, 'users', userCredential.user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if(userDoc.exists() && userDoc.data().passwordResetRequired) {
                        await updateDoc(userDocRef, {
                            passwordLastUpdatedAt: Timestamp.now(),
                            passwordResetRequired: false
                        });
                    }
                } catch (error) { 
                    errorEl.textContent = "Invalid email or password."; 
                } 
            });

            document.getElementById('register-form').addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const name = document.getElementById('register-name').value; 
                const email = document.getElementById('register-email').value; 
                const password = document.getElementById('register-password').value; 
                const errorEl = document.getElementById('register-error');
                errorEl.textContent = '';
                try { 
                    const cred = await createUserWithEmailAndPassword(auth, email, password); 
                    await updateProfile(cred.user, { displayName: name }); 
                    await setDoc(doc(db, "users", cred.user.uid), { 
                        name, 
                        email, 
                        role: 'referrer', 
                        commissionSplit: 50, 
                        waivesAllFees: false, 
                        currentTier: 'Bronze', 
                        wonReferralsCount: 0,
                        passwordLastUpdatedAt: Timestamp.now() 
                    }); 
                } catch (error) { 
                    errorEl.textContent = error.message; 
                } 
            });
            
            function togglePasswordVisibility(inputId, toggleId) {
                const passwordInput = document.getElementById(inputId);
                const toggleIcon = document.getElementById(toggleId);
                if (passwordInput.type === 'password') {
                    passwordInput.type = 'text';
                    toggleIcon.classList.remove('fa-eye');
                    toggleIcon.classList.add('fa-eye-slash');
                } else {
                    passwordInput.type = 'password';
                    toggleIcon.classList.remove('fa-eye-slash');
                    toggleIcon.classList.add('fa-eye');
                }
            }

            document.getElementById('toggle-login-password').addEventListener('click', () => togglePasswordVisibility('login-password', 'toggle-login-password'));
            document.getElementById('toggle-register-password').addEventListener('click', () => togglePasswordVisibility('register-password', 'toggle-register-password'));

            const resetModal = document.getElementById('reset-password-modal');
            document.getElementById('forgot-password-link').addEventListener('click', (e) => {
                e.preventDefault();
                resetModal.classList.remove('hidden');
            });
            document.getElementById('close-reset-modal-btn').addEventListener('click', () => resetModal.classList.add('hidden'));
            document.getElementById('reset-password-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('reset-email').value;
                const messageEl = document.getElementById('reset-message');
                messageEl.textContent = 'Sending...';
                messageEl.classList.remove('text-red-500', 'text-green-500');

                try {
                    await sendPasswordResetEmail(auth, email);
                    messageEl.textContent = 'Password reset email sent! Check your inbox.';
                    messageEl.classList.add('text-green-500');
                } catch (error) {
                    messageEl.textContent = 'Error sending email. Please check the address.';
                    messageEl.classList.add('text-red-500');
                    console.error("Password reset error:", error);
                }
            });

            document.getElementById('force-reset-logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('force-reset-send-link-btn').addEventListener('click', async () => {
                const messageEl = document.getElementById('force-reset-message');
                messageEl.textContent = 'Sending...';
                messageEl.classList.remove('text-red-500', 'text-green-500');
                try {
                    await sendPasswordResetEmail(auth, auth.currentUser.email);
                    await updateDoc(doc(db, 'users', auth.currentUser.uid), { passwordResetRequired: true });
                    messageEl.textContent = 'Password reset email sent! Please check your inbox, reset your password, then log out and sign back in.';
                    messageEl.classList.add('text-green-500');
                } catch (error) {
                     messageEl.textContent = 'Error sending reset email.';
                    messageEl.classList.add('text-red-500');
                }
            });
        }
    </script>
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(err => {
                    console.log('Service Worker registration failed:', err);
                });
        });
    }
</script>
</body>

</html>
