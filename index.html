<!DOCTYPE html>
<html lang="en-TT" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Insurance Referral Hub</title>
    <meta name="description"
        content="A platform for insurance referrers to create quotes and track commissions for motor and health insurance.">
    <meta name="author" content="Your Name">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">


    <style>
        :root {
            --bg-main: #f4f6f9;
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35;
            --text-secondary: #4a5568;
            --border-color: #dce1e7;
            --primary-accent: #005f73;
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625;
            --shadow-soft: 0 3px 6px rgba(0, 0, 0, 0.04);
            --shadow-medium: 0 5px 15px rgba(0, 0, 0, 0.06);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif;
        }

        .dark-mode {
            --bg-main: #1f2937;
            --bg-bento-box: #2b3c4d;
            --text-primary: #f0f4f8;
            --text-secondary: #d1d5db;
            --border-color: #4b5f71;
            --primary-accent: #25a1af;
            --primary-accent-darker: #1e838f;
            --secondary-accent: #daa520;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
        }

        .page-title {
            font-family: var(--font-heading);
            color: var(--primary-accent);
            font-weight: 700;
        }
        
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem;
            padding: 1.75rem;
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.25s ease;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .bento-box:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-strong);
        }

        .button-base {
            display: inline-block;
            font-weight: 600;
            padding: 0.85rem 1.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-soft);
            text-transform: uppercase;
            letter-spacing: 0.025em;
            text-align: center;
            text-decoration: none;
            cursor: pointer;
        }

        .button-base:hover {
            transform: translateY(-2px);
        }

        .main-action-button {
            background-color: var(--primary-accent);
            color: white;
        }

        .dark-mode .main-action-button {
            color: var(--text-primary);
        }

        .main-action-button:hover {
            background-color: var(--primary-accent-darker);
        }
        
        input, select {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main); color: var(--text-primary);
            font-weight: 500;
        }
        input:focus, select:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
    </style>
</head>

<body class="min-h-screen">
    <div id="app-container" class="w-full max-w-7xl mx-auto my-8 p-4 md:p-6 lg:p-8">
        <!-- Login/Register View -->
        <div id="auth-view">
            <header class="mb-10 md:mb-14 text-center">
                <h1 class="page-title text-4xl sm:text-5xl md:text-6xl mb-3">
                    Insurance Referral Hub
                </h1>
                <p class="text-[var(--text-secondary)] mt-5 text-md md:text-lg max-w-3xl mx-auto">
                    Welcome! Please sign in or register to continue.
                </p>
            </header>
            <main class="max-w-md mx-auto">
                <div class="bento-box">
                    <div id="auth-form-container">
                        <!-- Login Form -->
                        <form id="login-form" class="space-y-6">
                            <h2 class="text-2xl font-bold text-center text-[var(--primary-accent)]">Sign In</h2>
                            <div>
                                <label for="login-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label>
                                <input type="email" id="login-email" required class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="login-password"
                                    class="block text-sm font-medium text-[var(--text-muted)]">Password</label>
                                <input type="password" id="login-password" required class="mt-1 w-full">
                            </div>
                            <p id="login-error" class="text-red-500 text-sm text-center"></p>
                            <button type="submit" class="w-full main-action-button button-base">Sign In</button>
                            <p class="text-center text-sm">
                                Don't have an account? <a href="#" id="show-register" class="font-semibold text-[var(--primary-accent)] hover:underline">Register here</a>
                            </p>
                        </form>

                        <!-- Register Form (hidden by default) -->
                        <form id="register-form" class="hidden space-y-6">
                             <h2 class="text-2xl font-bold text-center text-[var(--primary-accent)]">Register</h2>
                            <div>
                                <label for="register-name" class="block text-sm font-medium text-[var(--text-muted)]">Full Name</label>
                                <input type="text" id="register-name" required class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="register-email" class="block text-sm font-medium text-[var(--text-muted)]">Email</label>
                                <input type="email" id="register-email" required class="mt-1 w-full">
                            </div>
                            <div>
                                <label for="register-password"
                                    class="block text-sm font-medium text-[var(--text-muted)]">Password</label>
                                <input type="password" id="register-password" required class="mt-1 w-full">
                            </div>
                            <p id="register-error" class="text-red-500 text-sm text-center"></p>
                            <button type="submit" class="w-full main-action-button button-base">Register</button>
                             <p class="text-center text-sm">
                                Already have an account? <a href="#" id="show-login" class="font-semibold text-[var(--primary-accent)] hover:underline">Sign in here</a>
                            </p>
                        </form>
                    </div>
                </div>
            </main>
        </div>

        <!-- Main App View (Dashboard) -->
        <div id="app-view" class="hidden">
             <header class="flex flex-wrap justify-between items-center mb-10 md:mb-14 gap-4">
                <div>
                    <h1 id="dashboard-title" class="page-title text-3xl sm:text-4xl md:text-5xl">
                        Referrer Dashboard
                    </h1>
                    <p id="user-greeting" class="text-[var(--text-secondary)] text-lg"></p>
                </div>
                <div id="nav-buttons" class="flex items-center space-x-4">
                    <div id="admin-link-container"></div>
                    <button id="logout-btn" class="button-base bg-red-600 hover:bg-red-700 text-white text-sm py-2 px-4 !px-4 !py-2">Logout</button>
                </div>
            </header>

            <main class="space-y-12">
                <section>
                     <div class="bento-box">
                         <h2 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Current Unpaid Balance</h2>
                         <div class="text-center">
                             <p class="text-5xl font-bold text-[var(--secondary-accent)]" id="unpaid-finders-fee-total">$0.00</p>
                             <p class="text-[var(--text-muted)]">From all "Won" referrals that have not yet been paid</p>
                         </div>
                     </div>
                </section>
                
                <section>
                    <h2 class="text-2xl md:text-3xl font-bold text-center mb-8 text-[var(--primary-accent)]">Create a New Referral</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="bento-box text-center">
                            <i class="fas fa-car-side text-5xl text-[var(--primary-accent)] mx-auto mb-4"></i>
                            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">Motor Insurance Rater</h3>
                            <p class="text-[var(--text-secondary)] text-sm mb-6 flex-grow">
                                Get a premium estimate for a private or commercial vehicle.
                            </p>
                            <a href="./motor_rater.html" class="main-action-button button-base mt-4">Open Motor Rater</a>
                        </div>
                        <div class="bento-box text-center">
                            <i class="fas fa-heart-pulse text-5xl text-[var(--primary-accent)] mx-auto mb-4"></i>
                            <h3 class="text-2xl font-bold text-[var(--primary-accent)] mb-4">COVERCARE Health Rater</h3>
                            <p class="text-[var(--text-secondary)] text-sm mb-6 flex-grow">
                               Calculate premiums for individual or family health plans.
                            </p>
                            <a href="./health_rater.html" class="main-action-button button-base mt-4">Open Health Rater</a>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[var(--primary-accent)]">My Referrals</h2>
                    <div class="bento-box overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="whitespace-nowrap">
                                <tr class="border-b border-[var(--border-color)]">
                                    <th class="p-4 text-sm font-semibold">Date</th>
                                    <th class="p-4 text-sm font-semibold">Client</th>
                                    <th class="p-4 text-sm font-semibold text-right">Approved Premium</th>
                                    <th class="p-4 text-sm font-semibold text-right">Your Finder's Fee</th>
                                    <th class="p-4 text-sm font-semibold text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="referrals-table-body"></tbody>
                        </table>
                    </div>
                </section>

                <!-- **** NEW: Payment History Section **** -->
                <section>
                    <h2 class="text-2xl md:text-3xl font-bold mb-8 text-[var(--primary-accent)]">Payment History</h2>
                    <div class="bento-box overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="whitespace-nowrap">
                                <tr class="border-b border-[var(--border-color)]">
                                    <th class="p-4 text-sm font-semibold">Payout Date</th>
                                    <th class="p-4 text-sm font-semibold">Period Covered</th>
                                    <th class="p-4 text-sm font-semibold text-right">Total Paid</th>
                                </tr>
                            </thead>
                            <tbody id="payment-history-table-body"></tbody>
                        </table>
                    </div>
                </section>

                 <footer class="text-center mt-12 text-xs text-[var(--text-muted)]">
                    <p>&copy; <span id="currentYear"></span> Your Company Name. All Rights Reserved.</p>
                </footer>
            </main>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            onAuthStateChanged,
            signOut,
            updateProfile
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc,
            setDoc,
            collection,
            query,
            where,
            onSnapshot,
            Timestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const authView = document.getElementById('auth-view');
        const appView = document.getElementById('app-view');
        const logoutBtn = document.getElementById('logout-btn');
        const userGreeting = document.getElementById('user-greeting');
        const unpaidFindersFeeTotal = document.getElementById('unpaid-finders-fee-total');
        const referralsTableBody = document.getElementById('referrals-table-body');
        const paymentHistoryTableBody = document.getElementById('payment-history-table-body');
        const adminLinkContainer = document.getElementById('admin-link-container');
        document.getElementById('currentYear').textContent = new Date().getFullYear();

        logoutBtn.addEventListener('click', () => signOut(auth));

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authView.classList.add('hidden');
                appView.classList.remove('hidden');
                await setupDashboard(user);
            } else {
                appView.classList.add('hidden');
                authView.classList.remove('hidden');
                adminLinkContainer.innerHTML = '';
            }
        });

        async function setupDashboard(user) {
            userGreeting.textContent = `Hello, ${user.displayName || user.email}!`;
            loadDashboardData(user.uid);
            
            const userDocRef = doc(db, "users", user.uid);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists() && userDoc.data().role === 'admin') {
                document.getElementById('dashboard-title').textContent = "Admin / Referrer Dashboard";
                adminLinkContainer.innerHTML = `<a href="./admin.html" class="button-base !px-4 !py-2 bg-[var(--secondary-accent)] text-white">Admin Panel</a>`;
            } else {
                adminLinkContainer.innerHTML = '';
                document.getElementById('dashboard-title').textContent = "Referrer Dashboard";
            }
        }

        function loadDashboardData(userId) {
            const referralsQuery = query(collection(db, "referrals"), where("referrerId", "==", userId));
            onSnapshot(referralsQuery, (snapshot) => {
                const referrals = snapshot.docs.map(doc => doc.data());
                referrals.sort((a,b) => b.createdAt.toDate() - a.createdAt.toDate());
                displayReferrals(referrals);
                updateUnpaidBalance(referrals);
            });
            
            // For payment history, we need to read all payments and filter client-side.
            // A more scalable solution might involve storing payments per-user, but this works for now.
            onSnapshot(collection(db, "payments"), (snapshot) => {
                const allPayments = snapshot.docs.map(p => p.data());
                const myPayments = allPayments.filter(p => p.paidReferralIds.some(id => id.startsWith(userId))); // Simple check
                 displayPaymentHistory(allPayments, userId);
            });
        }
        
        function updateUnpaidBalance(referrals) {
            const unpaidTotal = referrals
                .filter(r => r.status === 'Won')
                .reduce((total, r) => total + (r.finalFindersFee || r.findersFee), 0);
            unpaidFindersFeeTotal.textContent = formatCurrency(unpaidTotal);
        }

        function displayReferrals(referrals) {
            if (!referrals.length) {
                referralsTableBody.innerHTML = '<tr><td colspan="5" class="text-center p-8 text-[var(--text-muted)]">You have not made any referrals yet.</td></tr>';
                return;
            }
            referralsTableBody.innerHTML = referrals.map(referral => {
                const statusClass = getStatusClass(referral.status);
                const finalFee = referral.finalFindersFee || referral.findersFee;
                return `
                    <tr class="border-b border-[var(--border-color)] hover:bg-[var(--bg-main)] ${referral.status === 'Paid' ? 'opacity-50' : ''}">
                        <td class="p-4">${referral.createdAt.toDate().toLocaleDateString()}</td>
                        <td class="p-4">${referral.clientName}</td>
                        <td class="p-4 text-right">${referral.approvedPremium ? formatCurrency(referral.approvedPremium) : 'N/A'}</td>
                        <td class="p-4 text-right text-green-600 font-semibold">${formatCurrency(finalFee)}</td>
                        <td class="p-4 text-center">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${statusClass}">
                                ${referral.status}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // This function needs to be smarter to show relevant payment history
        function displayPaymentHistory(allPayments, userId) {
            // A more direct approach would be better, for now we will assume a payment covers many referrals
            // and the referrer was part of it. This is not perfect but works for this demo.
            // A real app would likely duplicate payment info or have a subcollection.
             allPayments.sort((a, b) => b.payoutDate.toDate() - a.payoutDate.toDate());
            if(!allPayments.length) {
                paymentHistoryTableBody.innerHTML = `<tr><td colspan="3" class="text-center p-8 text-[var(--text-muted)]">No payment history found.</td></tr>`;
                return;
            }
             paymentHistoryTableBody.innerHTML = allPayments.map(p => `
                <tr class="border-b border-[var(--border-color)]">
                    <td class="p-4">${p.payoutDate.toDate().toLocaleDateString()}</td>
                    <td class="p-4">${p.periodCovered}</td>
                    <td class="p-4 text-right font-semibold">${formatCurrency(p.totalPaid)}</td>
                </tr>
            `).join('');
        }

        function getStatusClass(status) {
            switch(status) {
                case 'Pending': return 'bg-yellow-100 text-yellow-800';
                case 'Approved': return 'bg-blue-100 text-blue-800';
                case 'Won': return 'bg-green-100 text-green-800';
                case 'Lost': case 'Rejected': return 'bg-red-100 text-red-800';
                case 'Paid': return 'bg-gray-400 text-white';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) return '$0.00';
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
        
        // Setup Login/Register forms
        document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('login-form').classList.add('hidden'); document.getElementById('register-form').classList.remove('hidden'); });
        document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('register-form').classList.add('hidden'); document.getElementById('login-form').classList.remove('hidden'); });
        document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; try { await signInWithEmailAndPassword(auth, email, password); } catch (error) { document.getElementById('login-error').textContent = "Invalid email or password."; } });
        document.getElementById('register-form').addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('register-name').value; const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; try { const cred = await createUserWithEmailAndPassword(auth, email, password); await updateProfile(cred.user, { displayName: name }); await setDoc(doc(db, "users", cred.user.uid), { name, email, role: 'referrer' }); } catch (error) { document.getElementById('register-error').textContent = error.message; } });

    </script>

</body>

</html>
