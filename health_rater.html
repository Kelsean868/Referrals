<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TATIL COVERCARE Premium Rater</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Source+Serif+Pro:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-main: #f4f6f9; 
            --bg-bento-box: #ffffff;
            --text-primary: #1d2d35; 
            --text-secondary: #4a5568; 
            --text-muted: #718096;    
            --border-color: #dce1e7; 
            --primary-accent: #005f73; 
            --primary-accent-darker: #003d4d;
            --secondary-accent: #ae8625; 
            --shadow-soft: 0 3px 6px rgba(0,0,0,0.04);
            --shadow-medium: 0 5px 15px rgba(0,0,0,0.06);
            --shadow-strong: 0 8px 25px rgba(0,0,0,0.08);
            --font-body: 'Montserrat', sans-serif;
            --font-heading: 'Source Serif Pro', serif; 
        }
        body {
            font-family: var(--font-body);
            background-color: var(--bg-main);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        h1, h2, h3, h4 { font-family: var(--font-heading); color: var(--primary-accent); }
        .bento-box {
            background-color: var(--bg-bento-box);
            border-radius: 0.75rem; 
            padding: 1.75rem; 
            box-shadow: var(--shadow-medium);
            transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
            border: 1px solid var(--border-color);
        }
        .bento-box:hover { transform: translateY(-5px); box-shadow: var(--shadow-strong); }
        input, select {
            border: 1px solid var(--border-color); padding: 0.85rem 1.15rem; border-radius: 0.375rem; 
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease, color 0.3s ease;
            background-color: var(--bg-main); color: var(--text-primary);
            font-weight: 500;
        }
        input:focus, select:focus {
            border-color: var(--primary-accent); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-accent) 25%, transparent); 
            outline: none; background-color: var(--bg-bento-box);
        }
        .button-base {
            font-weight: 600; padding-top: 0.85rem; padding-bottom: 0.85rem; border-radius: 0.375rem;
            transition: background-color 0.2s ease, transform 0.15s ease, box-shadow 0.2s ease;
            box-shadow: var(--shadow-soft); text-transform: uppercase; letter-spacing: 0.025em; cursor: pointer;
        }
        .button-base:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
        .primary-btn { background-color: var(--primary-accent); color: white; }
        .primary-btn:hover { background-color: var(--primary-accent-darker); }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(29, 45, 53, 0.7);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            backdrop-filter: blur(5px);
        }
        .modal-content {
            background-color: var(--bg-bento-box); margin: auto; padding: 2rem; border: 1px solid var(--border-color);
            width: 90%; max-width: 560px; border-radius: 0.75rem; position: relative;
            box-shadow: var(--shadow-strong);
        }
        .breakdown-row { display: flex; justify-content: space-between; flex-wrap: wrap; }
        .loader {
            width: 48px; height: 48px; border: 5px solid var(--primary-accent);
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8">

    <div class="fixed top-4 right-4 z-[101] flex items-center space-x-4">
        <a href="./index.html" class="text-sm font-semibold text-[var(--primary-accent)] hover:underline">&larr; Back to Dashboard</a>
    </div>

    <div id="health-rater-app" class="w-full max-w-6xl mx-auto my-8 hidden">
        <header class="mb-10 text-center">
            <h1 class="text-4xl sm:text-5xl font-bold mb-3">Health Insurance Referral Rater</h1>
            <p class="text-xl text-[var(--text-secondary)]">Health Insurance Plans, Simplified.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-5 gap-8">
            <div class="lg:col-span-3 space-y-8">
                <div class="bento-box">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-users mr-3 text-[var(--secondary-accent)]"></i>Insured Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="family-status" class="block text-sm font-medium text-[var(--text-muted)]">Family Status</label>
                            <select id="family-status" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="age-band" class="block text-sm font-medium text-[var(--text-muted)]">Age Band</label>
                            <select id="age-band" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="children-count" class="block text-sm font-medium text-[var(--text-muted)]">Number of Children</label>
                            <select id="children-count" class="mt-1 w-full p-2.5"></select>
                        </div>
                    </div>
                </div>
                <div class="bento-box">
                    <h2 class="text-2xl font-bold mb-4"><i class="fas fa-clipboard-list mr-3 text-[var(--secondary-accent)]"></i>Plan Options</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="plan-type" class="block text-sm font-medium text-[var(--text-muted)]">Plan Type</label>
                             <select id="plan-type" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div>
                            <label for="payment-frequency" class="block text-sm font-medium text-[var(--text-muted)]">Payment Frequency</label>
                            <select id="payment-frequency" class="mt-1 w-full p-2.5"></select>
                        </div>
                        <div id="base-plan-options" class="contents">
                            <div>
                                <label for="dental-vision" class="block text-sm font-medium text-[var(--text-muted)]">Dental & Vision Included</label>
                                <select id="dental-vision" class="mt-1 w-full p-2.5"></select>
                            </div>
                            <div id="maternity-container">
                                <label for="maternity" class="block text-sm font-medium text-[var(--text-muted)]">Maternity Coverage</label>
                                 <select id="maternity" class="mt-1 w-full p-2.5"></select>
                            </div>
                        </div>
                         <div id="major-medical-options" class="contents">
                             <div>
                                <label for="major-medical-amount" class="block text-sm font-medium text-[var(--text-muted)]">Major Medical Coverage</label>
                                <select id="major-medical-amount" class="mt-1 w-full p-2.5"></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="lg:col-span-2">
                 <div id="results-section" class="bento-box sticky top-8 text-center">
                    <h2 class="text-2xl font-bold mb-2"><i class="fas fa-receipt mr-3 text-[var(--secondary-accent)]"></i>Premium Summary</h2>
                    <p id="total-premium" class="text-4xl font-bold text-[var(--primary-accent)] mt-4">$0.00</p>
                    <p id="total-premium-label" class="text-sm text-[var(--text-muted)]">(Total Annual Premium)</p>
                    <div id="premium-breakdown" class="text-left mt-6 pt-4 border-t border-[var(--border-color)] text-[var(--text-secondary)] text-sm space-y-1"></div>
                    
                    <div id="finders-fee-section" class="text-left mt-6 pt-4 border-t-2 border-dashed border-[var(--secondary-accent)]">
                        <h3 class="text-lg font-bold text-[var(--primary-accent)] mb-2">Initial Finder's Fee</h3>
                        <div id="finders-fee-breakdown" class="text-[var(--text-secondary)] text-sm space-y-1"></div>
                    </div>
                     
                    <button id="create-referral-btn" class="mt-6 w-full primary-btn button-base py-3">
                        Create Referral
                    </button>
                </div>
            </div>
        </main>
    </div>

    <div id="auth-loader" class="text-center p-20">
        <div class="loader mx-auto"></div>
        <p class="mt-4 text-[var(--text-secondary)]">Authenticating...</p>
    </div>

    <div id="client-info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold leading-6 mb-4">Client Information for Referral</h3>
            <div class="space-y-4">
                <input type="text" id="client-name" placeholder="Client's Full Name" class="w-full" required>
                <input type="email" id="client-email" placeholder="Client's Email" class="w-full" required>
                <input type="text" id="client-contact" placeholder="Client's Contact Number" class="w-full" required>
            </div>
            <p id="client-modal-error" class="text-red-500 text-sm text-center mt-4"></p>
            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" id="close-client-modal-btn" class="button-base bg-gray-200 text-gray-700">Cancel</button>
                <button type="button" id="submit-referral-btn" class="button-base primary-btn">Submit Referral</button>
            </div>
        </div>
    </div>

    <div id="success-modal" class="modal-overlay hidden">
        <div class="modal-content text-center">
            <i class="fas fa-check-circle text-5xl text-green-500 mx-auto mb-4"></i>
            <h3 class="text-xl font-bold leading-6 mb-2">Referral Submitted!</h3>
            <p class="text-[var(--text-secondary)]">Your referral has been sent for approval. You can track its status on your dashboard.</p>
            <div class="mt-6">
                 <a href="./index.html" class="button-base primary-btn py-2 px-4">Back to Dashboard</a>
            </div>
        </div>
    </div>
    
    <script src="health_rater_data.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC5hOOzqCPieEpg5ajCBhsScroaB-c1kYg",
            authDomain: "insurance-referrer-hub.firebaseapp.com",
            projectId: "insurance-referrer-hub",
            storageBucket: "insurance-referrer-hub.appspot.com",
            messagingSenderId: "1007719344655",
            appId: "1:1007719344655:web:6e5565f2f957300e8fd17a",
            measurementId: "G-T9W94R7QJF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let lastCalculatedData = {};

        onAuthStateChanged(auth, (user) => {
            const appEl = document.getElementById('health-rater-app');
            const loaderEl = document.getElementById('auth-loader');
            if (user) {
                currentUser = user;
                appEl.classList.remove('hidden');
                loaderEl.classList.add('hidden');
                populateDropdowns();
                calculateAndDisplay();
            } else {
                loaderEl.innerHTML = `
                     <div class="text-center bento-box max-w-lg mx-auto">
                        <h3 class="text-xl font-bold leading-6 mb-2">Authentication Error</h3>
                        <p class="text-[var(--text-secondary)]">You must be logged in to use the rater.</p>
                        <div class="mt-6">
                            <a href="./index.html" class="button-base primary-btn py-2 px-4">Go to Login</a>
                        </div>
                    </div>
                `;
                appEl.classList.add('hidden');
                loaderEl.classList.remove('hidden');
            }
        });
        
        const allInputs = document.querySelectorAll('select');
        const createReferralBtn = document.getElementById('create-referral-btn');
        const clientInfoModal = document.getElementById('client-info-modal');
        const closeModalBtn = document.getElementById('close-client-modal-btn');
        const submitReferralBtn = document.getElementById('submit-referral-btn');
        const successModal = document.getElementById('success-modal');
        const findersFeeBreakdownEl = document.getElementById('finders-fee-breakdown');
        
        allInputs.forEach(input => {
            input.addEventListener('change', calculateAndDisplay);
        });

        createReferralBtn.addEventListener('click', () => {
            if (lastCalculatedData.totalPremium > 0) {
                 clientInfoModal.style.display = 'flex';
            } else {
                alert("Please calculate a premium first.");
            }
        });

        closeModalBtn.addEventListener('click', () => clientInfoModal.style.display = 'none');
        submitReferralBtn.addEventListener('click', submitReferral);

        function populateDropdowns() {
            const options = {
                'family-status': {'Single Male': 'single_male', 'Single Female': 'single_female', 'Husband & Wife': 'husband_wife'},
                'age-band': {'Under 40': 'under_40', '40-49': '40_49', '50-59': '50_59', '60-65': '60_65', '66-67': '66_67', '68-70': '68_70'},
                'children-count': {'0 Children': '0', '1 Child': '1', '2 or More': '2+'},
                'plan-type': {'Base Plan + Major Medical': 'base_and_mm', 'Base Plan Only': 'base_only', 'Major Medical Only': 'mm_only'},
                'payment-frequency': {'Annual': 'annual', 'Semi-Annual': 'semi', 'Quarterly': 'quarterly'},
                'dental-vision': {'No': 'no', 'Yes': 'yes'},
                'maternity': {'No': 'no', 'Yes': 'yes'},
                'major-medical-amount': {'$50,000': '50000', '$100,000': '100000', '$200,000': '200000', '$300,000': '300000', '$500,000': '500000'}
            };
            for(const id in options) {
                const select = document.getElementById(id);
                select.innerHTML = Object.entries(options[id]).map(([text, value]) => `<option value="${value}">${text}</option>`).join('');
            }
        }

        function getElement(id) { return document.getElementById(id); }
        
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) { return 'N/A'; }
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }
        
        function handleUIChanges() {
            const planType = getElement('plan-type').value;
            const familyStatus = getElement('family-status').value;
            const ageBand = getElement('age-band').value;
            
            getElement('base-plan-options').style.display = (planType === 'mm_only') ? 'none' : 'contents';
            getElement('major-medical-options').style.display = (planType === 'base_only') ? 'none' : 'contents';
            
            const maternityContainer = getElement('maternity-container');
            const maternitySelect = getElement('maternity');
            if ((familyStatus === 'single_female' || familyStatus === 'husband_wife') && planType !== 'mm_only') {
                maternityContainer.style.display = 'block';
                const isMaternityEligible = !['50_59', '60_65', '66_67', '68_70'].includes(ageBand);
                maternitySelect.disabled = !isMaternityEligible;
                if(!isMaternityEligible) maternitySelect.value = 'no';
            } else {
                maternityContainer.style.display = 'none';
                maternitySelect.value = 'no';
            }
        }

        function calculateAndDisplay() {
            if(typeof RATES === 'undefined') {
                document.body.innerHTML = 'Error: Rate data not found.';
                return;
            }
            handleUIChanges();

            const planType = getElement('plan-type').value;
            const familyStatus = getElement('family-status').value;
            const ageBand = getElement('age-band').value;
            const childrenCount = getElement('children-count').value;
            const maternity = getElement('maternity').value;
            const withDV = getElement('dental-vision').value === 'yes';
            const mmAmount = getElement('major-medical-amount').value;
            const frequency = getElement('payment-frequency').value;

            let baseRateSet = {annual:0, semi:0, quarterly:0};
            if (planType !== 'mm_only') {
                let baseRateKey = familyStatus + ((familyStatus === 'single_female' || familyStatus === 'husband_wife') ? ((maternity === 'yes' && !getElement('maternity').disabled) ? '_with_maternity' : '_no_maternity') : '');
                baseRateSet = (withDV ? RATES.base.with_dv : RATES.base.standard)[baseRateKey]?.[ageBand]?.[childrenCount] || baseRateSet;
            }

            let mmRateSet = {annual:0, semi:0, quarterly:0};
            if (planType !== 'base_only') {
                let mmRateKey = familyStatus.startsWith('single_female') ? 'single_female' : familyStatus;
                mmRateSet = RATES.major_medical[mmAmount]?.[mmRateKey]?.[ageBand]?.[childrenCount === '0' ? '0' : '1+'] || mmRateSet;
            }

            const totalPremium = (baseRateSet[frequency] || 0) + (mmRateSet[frequency] || 0);
            getElement('total-premium').textContent = formatCurrency(totalPremium);
            getElement('total-premium-label').textContent = `(Total ${frequency.charAt(0).toUpperCase() + frequency.slice(1)} Premium)`;
            
            let breakdownHTML = ``;
            if (planType !== 'mm_only') breakdownHTML += `<p class="breakdown-row"><span>COVERCARE Base Premium:</span> <strong>${formatCurrency(baseRateSet[frequency])}</strong></p>`;
            if (planType !== 'base_only') breakdownHTML += `<p class="breakdown-row"><span>Major Medical:</span> <strong>${formatCurrency(mmRateSet[frequency])}</strong></p>`;
            breakdownHTML += `<p class="breakdown-row font-bold text-lg border-t border-[var(--border-color)] pt-2 mt-2"><span>Total Premium:</span> <strong>${formatCurrency(totalPremium)}</strong></p>`;
            getElement('premium-breakdown').innerHTML = breakdownHTML;
            
            const annualPremium = (baseRateSet.annual || 0) + (mmRateSet.annual || 0);

            lastCalculatedData = {
                insuranceType: 'Health',
                totalPremium: totalPremium,
                premiumBeforeTax: annualPremium 
            };
            calculateAndDisplayFindersFee(annualPremium);
        }

        function calculateAndDisplayFindersFee(preTaxPremium) {
            const totalCommission = preTaxPremium * 0.25;
            const incomeTax = totalCommission * 0.25;
            const netCommission = totalCommission - incomeTax;
            const findersFee = netCommission * 0.50;
            lastCalculatedData.findersFee = findersFee;

            findersFeeBreakdownEl.innerHTML = `
                <div class="breakdown-row"><span>Pre-Tax Annual Premium</span><span class="font-semibold">${formatCurrency(preTaxPremium)}</span></div>
                <div class="breakdown-row mt-2"><span>Total Commission (25%)</span><span class="font-semibold">${formatCurrency(totalCommission)}</span></div>
                <div class="breakdown-row text-red-600"><span>- Income Tax (25%)</span><span>-${formatCurrency(incomeTax)}</span></div>
                <div class="breakdown-row font-semibold border-t border-[var(--border-color)] pt-1 mt-1"><span>Net Commission Payable</span><span>${formatCurrency(netCommission)}</span></div>
                <div class="breakdown-row text-green-600 mt-2"><span class="font-bold">Your Finder's Fee (50%)</span><span class="font-bold">${formatCurrency(findersFee)}</span></div>
            `;
        }

        async function submitReferral() {
            const clientName = document.getElementById('client-name').value;
            const clientEmail = document.getElementById('client-email').value;
            const clientContact = document.getElementById('client-contact').value;
            const errorEl = document.getElementById('client-modal-error');
            
            if (!clientName || !clientEmail || !clientContact) {
                errorEl.textContent = "Please fill out all client fields.";
                return;
            }
            errorEl.textContent = "";

            submitReferralBtn.innerHTML = '<span class="loader !w-6 !h-6"></span>';
            submitReferralBtn.disabled = true;

            try {
                await addDoc(collection(db, "referrals"), {
                    ...lastCalculatedData,
                    referrerId: currentUser.uid,
                    referrerName: currentUser.displayName,
                    clientName, clientEmail, clientContact,
                    status: 'Pending',
                    createdAt: Timestamp.now()
                });
                clientInfoModal.style.display = 'none';
                successModal.style.display = 'flex';
            } catch (error) {
                console.error("Error adding document: ", error);
                errorEl.textContent = "Could not submit referral. Please try again.";
            } finally {
                submitReferralBtn.innerHTML = 'Submit Referral';
                submitReferralBtn.disabled = false;
            }
        }
    </script>
</body>
</html>
